(function(e){function r(e,t){return new r.prototype.init(e,t)}var t=0;"use strict";var n=function(e){this[0]=e.startOffset;this[1]=e.endOffset;this.range=e;return this};n.prototype.equals=function(){return this[0]===this[1]};e.fn.redactor=function(t){var n=[];var i=Array.prototype.slice.call(arguments,1);if(typeof t==="string"){this.each(function(){var r=e.data(this,"redactor");if(typeof r!=="undefined"&&e.isFunction(r[t])){var s=r[t].apply(r,i);if(s!==undefined&&s!==r)n.push(s)}else return e.error('No such method "'+t+'" for Redactor')})}else{this.each(function(){if(!e.data(this,"redactor"))e.data(this,"redactor",r(this,t))})}if(n.length===0)return this;else if(n.length===1)return n[0];else return n};e.Redactor=r;e.Redactor.VERSION="9.2";e.Redactor.opts={rangy:false,iframe:false,fullpage:false,css:false,lang:"en",direction:"ltr",placeholder:false,typewriter:false,wym:false,mobile:true,cleanup:true,tidyHtml:true,pastePlainText:false,removeEmptyTags:true,templateVars:false,xhtml:false,visual:true,focus:false,tabindex:false,autoresize:true,minHeight:false,maxHeight:false,shortcuts:true,autosave:false,autosaveInterval:60,plugins:false,linkAnchor:true,linkEmail:true,linkProtocol:"http://",linkNofollow:false,linkSize:50,imageFloatMargin:"10px",imageGetJson:false,dragUpload:true,imageTabLink:true,imageUpload:false,imageUploadParam:"file",fileUpload:false,fileUploadParam:"file",clipboardUpload:true,clipboardUploadUrl:false,dnbImageTypes:["image/png","image/jpeg","image/gif"],s3:false,uploadFields:false,observeImages:true,observeLinks:true,modalOverlay:true,tabSpaces:false,tabFocus:true,air:false,airButtons:["formatting","bold","italic","deleted","unorderedlist","orderedlist","outdent","indent"],toolbar:true,toolbarFixed:false,toolbarFixedTarget:document,toolbarFixedTopOffset:0,toolbarFixedBox:false,toolbarExternal:false,toolbarOverflow:false,buttonSource:true,buttons:["html","|","formatting","bold","italic","deleted","unorderedlist","orderedlist","outdent","indent","image","video","file","table","link","alignment","horizontalrule"],buttonsHideOnMobile:[],activeButtons:["deleted","italic","bold","underline","unorderedlist","orderedlist","alignleft","aligncenter","alignright","justify","table"],activeButtonsStates:{b:"bold",strong:"bold",i:"italic",em:"italic",del:"deleted",strike:"deleted",ul:"unorderedlist",ol:"orderedlist",u:"underline",tr:"table",td:"table",table:"table"},formattingTags:["p","blockquote","pre","h1","h2","h3","h4","h5","h6"],linebreaks:false,paragraphy:true,convertDivs:true,convertLinks:true,convertImageLinks:false,convertVideoLinks:false,formattingPre:false,phpTags:false,allowedTags:false,deniedTags:["html","head","link","body","meta","script","style","applet"],boldTag:"strong",italicTag:"em",indentValue:20,buffer:[],rebuffer:[],textareamode:false,emptyHtml:"<p>&#x200b;</p>",invisibleSpace:"&#x200b;",rBlockTest:/^(P|H[1-6]|LI|ADDRESS|SECTION|HEADER|FOOTER|ASIDE|ARTICLE)$/i,alignmentTags:["P","H1","H2","H3","H4","H5","H6","DD","DL","DT","DIV","TD","BLOCKQUOTE","OUTPUT","FIGCAPTION","ADDRESS","SECTION","HEADER","FOOTER","ASIDE","ARTICLE"],ownLine:["area","body","head","hr","i?frame","link","meta","noscript","style","script","table","tbody","thead","tfoot"],contOwnLine:["li","dt","dt","h[1-6]","option","script"],newLevel:["blockquote","div","dl","fieldset","form","frameset","map","ol","p","pre","select","td","th","tr","ul"],blockLevelElements:["P","H1","H2","H3","H4","H5","H6","DD","DL","DT","DIV","LI","BLOCKQUOTE","OUTPUT","FIGCAPTION","PRE","ADDRESS","SECTION","HEADER","FOOTER","ASIDE","ARTICLE","TD"],langs:{en:{html:"HTML",video:"Insert Video",image:"Insert Image",table:"Table",link:"Link",link_insert:"Insert link",link_edit:"Edit link",unlink:"Unlink",formatting:"Formatting",paragraph:"Normal text",quote:"Quote",code:"Code",header1:"Header 1",header2:"Header 2",header3:"Header 3",header4:"Header 4",header5:"Header 5",bold:"Bold",italic:"Italic",fontcolor:"Font Color",backcolor:"Back Color",unorderedlist:"Unordered List",orderedlist:"Ordered List",outdent:"Outdent",indent:"Indent",cancel:"Cancel",insert:"Insert",save:"Save",_delete:"Delete",insert_table:"Insert Table",insert_row_above:"Add Row Above",insert_row_below:"Add Row Below",insert_column_left:"Add Column Left",insert_column_right:"Add Column Right",delete_column:"Delete Column",delete_row:"Delete Row",delete_table:"Delete Table",rows:"Rows",columns:"Columns",add_head:"Add Head",delete_head:"Delete Head",title:"Title",image_position:"Position",none:"None",left:"Left",right:"Right",center:"Center",image_web_link:"Image Web Link",text:"Text",mailto:"Email",web:"URL",video_html_code:"Video Embed Code",file:"Insert File",upload:"Upload",download:"Download",choose:"Choose",or_choose:"Or choose",drop_file_here:"Drop file here",align_left:"Align text to the left",align_center:"Center text",align_right:"Align text to the right",align_justify:"Justify text",horizontalrule:"Insert Horizontal Rule",deleted:"Deleted",anchor:"Anchor",link_new_tab:"Open link in new tab",underline:"Underline",alignment:"Alignment",filename:"Name (optional)",edit:"Edit"}}};r.fn=e.Redactor.prototype={keyCode:{BACKSPACE:8,DELETE:46,DOWN:40,ENTER:13,ESC:27,TAB:9,CTRL:17,META:91,LEFT:37,LEFT_WIN:91},init:function(n,r){this.rtePaste=false;this.$element=this.$source=e(n);this.uuid=t++;var s=e.extend(true,{},e.Redactor.opts);this.opts=e.extend({},s,this.$element.data(),r);this.start=true;this.dropdowns=[];this.sourceHeight=this.$source.css("height");this.sourceWidth=this.$source.css("width");if(this.opts.fullpage)this.opts.iframe=true;if(this.opts.linebreaks)this.opts.paragraphy=false;if(this.opts.paragraphy)this.opts.linebreaks=false;if(this.opts.toolbarFixedBox)this.opts.toolbarFixed=true;this.document=document;this.window=window;this.savedSel=false;this.cleanlineBefore=new RegExp("^<(/?"+this.opts.ownLine.join("|/?")+"|"+this.opts.contOwnLine.join("|")+")[ >]");this.cleanlineAfter=new RegExp("^<(br|/?"+this.opts.ownLine.join("|/?")+"|/"+this.opts.contOwnLine.join("|/")+")[ >]");this.cleannewLevel=new RegExp("^</?("+this.opts.newLevel.join("|")+")[ >]");this.rTestBlock=new RegExp("^("+this.opts.blockLevelElements.join("|")+")$","i");if(this.opts.linebreaks===false){if(this.opts.allowedTags!==false){var o=["strong","em","del"];var u=["b","i","strike"];if(e.inArray("p",this.opts.allowedTags)==="-1")this.opts.allowedTags.push("p");for(i in o){if(e.inArray(o[i],this.opts.allowedTags)!="-1")this.opts.allowedTags.push(u[i])}}if(this.opts.deniedTags!==false){var a=e.inArray("p",this.opts.deniedTags);if(a!=="-1")this.opts.deniedTags.splice(a,a)}}if(this.browser("msie")||this.browser("opera")){this.opts.buttons=this.removeFromArrayByValue(this.opts.buttons,"horizontalrule")}this.opts.curLang=this.opts.langs[this.opts.lang];this.buildStart()},toolbarInit:function(e){return{html:{title:e.html,func:"toggle"},formatting:{title:e.formatting,func:"show",dropdown:{p:{title:e.paragraph,func:"formatBlocks"},blockquote:{title:e.quote,func:"formatQuote",className:"redactor_format_blockquote"},pre:{title:e.code,func:"formatBlocks",className:"redactor_format_pre"},h1:{title:e.header1,func:"formatBlocks",className:"redactor_format_h1"},h2:{title:e.header2,func:"formatBlocks",className:"redactor_format_h2"},h3:{title:e.header3,func:"formatBlocks",className:"redactor_format_h3"},h4:{title:e.header4,func:"formatBlocks",className:"redactor_format_h4"},h5:{title:e.header5,func:"formatBlocks",className:"redactor_format_h5"}}},bold:{title:e.bold,exec:"bold"},italic:{title:e.italic,exec:"italic"},deleted:{title:e.deleted,exec:"strikethrough"},underline:{title:e.underline,exec:"underline"},unorderedlist:{title:"&bull; "+e.unorderedlist,exec:"insertunorderedlist"},orderedlist:{title:"1. "+e.orderedlist,exec:"insertorderedlist"},outdent:{title:"< "+e.outdent,func:"indentingOutdent"},indent:{title:"> "+e.indent,func:"indentingIndent"},image:{title:e.image,func:"imageShow"},zurmoImage:{title:e.image,func:"zurmoImageShow"},video:{title:e.video,func:"videoShow"},file:{title:e.file,func:"fileShow"},table:{title:e.table,func:"show",dropdown:{insert_table:{title:e.insert_table,func:"tableShow"},separator_drop1:{name:"separator"},insert_row_above:{title:e.insert_row_above,func:"tableAddRowAbove"},insert_row_below:{title:e.insert_row_below,func:"tableAddRowBelow"},insert_column_left:{title:e.insert_column_left,func:"tableAddColumnLeft"},insert_column_right:{title:e.insert_column_right,func:"tableAddColumnRight"},separator_drop2:{name:"separator"},add_head:{title:e.add_head,func:"tableAddHead"},delete_head:{title:e.delete_head,func:"tableDeleteHead"},separator_drop3:{name:"separator"},delete_column:{title:e.delete_column,func:"tableDeleteColumn"},delete_row:{title:e.delete_row,func:"tableDeleteRow"},delete_table:{title:e.delete_table,func:"tableDeleteTable"}}},link:{title:e.link,func:"show",dropdown:{link:{title:e.link_insert,func:"linkShow"},unlink:{title:e.unlink,exec:"unlink"}}},fontcolor:{title:e.fontcolor,func:"show"},backcolor:{title:e.backcolor,func:"show"},alignment:{title:e.alignment,func:"show",dropdown:{alignleft:{title:e.align_left,func:"alignmentLeft"},aligncenter:{title:e.align_center,func:"alignmentCenter"},alignright:{title:e.align_right,func:"alignmentRight"},justify:{title:e.align_justify,func:"alignmentJustify"}}},alignleft:{title:e.align_left,func:"alignmentLeft"},aligncenter:{title:e.align_center,func:"alignmentCenter"},alignright:{title:e.align_right,func:"alignmentRight"},alignjustify:{title:e.align_justify,func:"alignmentJustify"},horizontalrule:{exec:"inserthorizontalrule",title:e.horizontalrule}}},callback:function(t,n,r){var i=this.opts[t+"Callback"];if(e.isFunction(i)){if(n===false)return i.call(this,r);else return i.call(this,n,r)}else return r},destroy:function(){clearInterval(this.autosaveInterval);e(window).off(".redactor");this.$source.off("redactor-textarea");this.$element.off(".redactor").removeData("redactor");var t=this.get();if(this.opts.textareamode){this.$box.after(this.$source);this.$box.remove();this.$source.val(t).show()}else{var n=this.$editor;if(this.opts.iframe)n=this.$element;this.$box.after(n);this.$box.remove();n.removeClass("redactor_editor").removeClass("redactor_editor_wym").removeAttr("contenteditable").html(t).show()}if(this.opts.toolbarExternal){e(this.opts.toolbarExternal).html("")}if(this.opts.air){e("#redactor_air_"+this.uuid).remove()}},getObject:function(){return e.extend({},this)},getEditor:function(){return this.$editor},getBox:function(){return this.$box},getIframe:function(){return this.opts.iframe?this.$frame:false},getToolbar:function(){return this.$toolbar?this.$toolbar:false},get:function(){return this.$source.val()},getCodeIframe:function(){this.$editor.removeAttr("contenteditable").removeAttr("dir");var e=this.outerHtml(this.$frame.contents().children());this.$editor.attr({contenteditable:true,dir:this.opts.direction});return e},set:function(e,t,n){e=e.toString();e=e.replace(/\$/g,"&#36;");if(this.opts.fullpage)this.setCodeIframe(e);else this.setEditor(e,t);if(e=="")n=false;if(n!==false)this.placeholderRemove()},setEditor:function(e,t){if(t!==false){e=this.cleanSavePreCode(e);e=this.cleanStripTags(e);e=this.cleanConvertProtected(e);e=this.cleanConvertInlineTags(e,true);if(this.opts.linebreaks===false)e=this.cleanConverters(e);else e=e.replace(/<p(.*?)>([\w\W]*?)<\/p>/gi,"$2<br>")}e=e.replace(/&#36;/g,"$");e=this.cleanEmpty(e);this.$editor.html(e);this.setNonEditable();this.setSpansVerified();this.sync()},setCodeIframe:function(e){var t=this.iframePage();this.$frame[0].src="about:blank";e=this.cleanConvertProtected(e);e=this.cleanConvertInlineTags(e);e=this.cleanRemoveSpaces(e);t.open();t.write(e);t.close();if(this.opts.fullpage){this.$editor=this.$frame.contents().find("body").attr({contenteditable:true,dir:this.opts.direction})}this.setNonEditable();this.setSpansVerified();this.sync()},setFullpageOnInit:function(e){e=this.cleanSavePreCode(e,true);e=this.cleanConverters(e);e=this.cleanEmpty(e);this.$editor.html(e);this.setNonEditable();this.setSpansVerified();this.sync()},setSpansVerified:function(){var t=this.$editor.find("span");var n="inline";e.each(t,function(){var t=this.outerHTML;var r=new RegExp("<"+this.tagName,"gi");var i=t.replace(r,"<"+n);r=new RegExp("</"+this.tagName,"gi");i=i.replace(r,"</"+n);e(this).replaceWith(i)})},setSpansVerifiedHtml:function(e){e=e.replace(/<span(.*?)>/,"<inline$1>");return e.replace(/<\/span>/,"</inline>")},setNonEditable:function(){this.$editor.find(".noneditable").attr("contenteditable",false)},sync:function(){var t="";this.cleanUnverified();if(this.opts.fullpage)t=this.getCodeIframe();else t=this.$editor.html();t=this.syncClean(t);t=this.cleanRemoveEmptyTags(t);var n=this.cleanRemoveSpaces(this.$source.val(),false);var r=this.cleanRemoveSpaces(t,false);if(n==r){return false}t=t.replace(/<\/li><(ul|ol)>([\w\W]*?)<\/(ul|ol)>/gi,"<$1>$2</$1></li>");if(e.trim(t)==="<br>")t="";if(this.opts.xhtml){var i=["br","hr","img","link","input","meta"];e.each(i,function(e,n){t=t.replace(new RegExp("<"+n+"(.*?[^/$]?)>","gi"),"<"+n+"$1 />")})}t=this.callback("syncBefore",false,t);this.$source.val(t);this.callback("syncAfter",false,t);if(this.start===false){this.callback("change",false,t)}},syncClean:function(t){if(!this.opts.fullpage)t=this.cleanStripTags(t);t=e.trim(t);t=this.placeholderRemoveFromCode(t);t=t.replace(/&#x200b;/gi,"");t=t.replace(/&#8203;/gi,"");t=t.replace(/<\/a>&nbsp;/gi,"</a> ");t=t.replace(/\u200B/g,"");if(t=="<p></p>"||t=="<p> </p>"||t=="<p>&nbsp;</p>"){t=""}if(this.opts.linkNofollow){t=t.replace(/<a(.*?)rel="nofollow"(.*?)>/gi,"<a$1$2>");t=t.replace(/<a(.*?)>/gi,'<a$1 rel="nofollow">')}t=t.replace("<!--?php","<?php");t=t.replace("?-->","?>");t=t.replace(/<(.*?)class="noeditable"(.*?) contenteditable="false"(.*?)>/gi,'<$1class="noeditable"$2$3>');t=t.replace(/ data-tagblock=""/gi,"");t=t.replace(/<br\s?\/?>\n?<\/(P|H[1-6]|LI|ADDRESS|SECTION|HEADER|FOOTER|ASIDE|ARTICLE)>/gi,"</$1>");t=t.replace(/<span(.*?)id="redactor-image-box"(.*?)>([\w\W]*?)<img(.*?)><\/span>/gi,"$3<img$4>");t=t.replace(/<span(.*?)id="redactor-image-resizer"(.*?)>(.*?)<\/span>/gi,"");t=t.replace(/<span(.*?)id="redactor-image-editter"(.*?)>(.*?)<\/span>/gi,"");t=t.replace(/<(ul|ol|li)([^>]*) style="(.*?)"(.*?)>/gi,"<$1$2$4>");t=t.replace(/<(ul|ol)>\s*\t*\n*<\/(ul|ol)>/gi,"");t=t.replace(/<font(.*?)>([\w\W]*?)<\/font>/gi,"$2");t=t.replace(/<span(.*?)>([\w\W]*?)<\/span>/gi,"$2");t=t.replace(/<inline>/gi,"<span>");t=t.replace(/<inline /gi,"<span ");t=t.replace(/<\/inline>/gi,"</span>");t=t.replace(/<span(.*?)class="redactor_placeholder"(.*?)>([\w\W]*?)<\/span>/gi,"");t=t.replace(/<span>([\w\W]*?)<\/span>/gi,"$1");t=t.replace(/&/gi,"&");t=t.replace(/™/gi,"&trade;");t=t.replace(/©/gi,"&copy;");t=this.cleanReConvertProtected(t);return t},buildStart:function(){this.content="";this.$box=e('<div class="redactor_box" />');this.$box.css("z-index",100-this.uuid);if(this.$source[0].tagName==="TEXTAREA")this.opts.textareamode=true;if(this.opts.mobile===false&&this.isMobile()){this.buildMobile()}else{this.buildContent();if(this.opts.iframe){this.opts.autoresize=false;this.iframeStart()}else if(this.opts.textareamode)this.buildFromTextarea();else this.buildFromElement();if(!this.opts.iframe){this.buildOptions();this.buildAfter()}}},buildMobile:function(){if(!this.opts.textareamode){this.$editor=this.$source;this.$editor.hide();this.$source=this.buildCodearea(this.$editor);this.$source.val(this.content)}this.$box.insertAfter(this.$source).append(this.$source)},buildContent:function(){if(this.opts.textareamode)this.content=e.trim(this.$source.val());else this.content=e.trim(this.$source.html())},buildFromTextarea:function(){this.$editor=e("<div />");this.$box.insertAfter(this.$source).append(this.$editor).append(this.$source);this.buildAddClasses(this.$editor);this.buildEnable()},buildFromElement:function(){this.$editor=this.$source;this.$source=this.buildCodearea(this.$editor);this.$box.insertAfter(this.$editor).append(this.$editor).append(this.$source);this.buildEnable()},buildCodearea:function(t){return e("<textarea />").attr("name",t.attr("id")).css("height",this.sourceHeight)},buildAddClasses:function(t){e.each(this.$source.get(0).className.split(/\s+/),function(e,n){t.addClass("redactor_"+n)})},buildEnable:function(){this.$editor.addClass("redactor_editor").attr({contenteditable:true,dir:this.opts.direction});this.$source.attr("dir",this.opts.direction).hide();this.set(this.content,true,false)},buildOptions:function(){var e=this.$editor;if(this.opts.iframe)e=this.$frame;if(this.opts.tabindex)e.attr("tabindex",this.opts.tabindex);if(this.opts.minHeight)e.css("min-height",this.opts.minHeight+"px");if(this.opts.maxHeight){this.opts.autoresize=false;this.sourceHeight=this.opts.maxHeight}if(this.opts.wym)this.$editor.addClass("redactor_editor_wym");if(this.opts.typewriter)this.$editor.addClass("redactor-editor-typewriter");if(!this.opts.autoresize)e.css("height",this.sourceHeight)},buildAfter:function(){this.start=false;if(this.opts.toolbar){this.opts.toolbar=this.toolbarInit(this.opts.curLang);this.toolbarBuild()}this.modalTemplatesInit();this.buildPlugins();this.buildBindKeyboard();if(this.opts.autosave)this.autosave();setTimeout(e.proxy(this.observeStart,this),4);if(this.browser("mozilla")){try{this.document.execCommand("enableObjectResizing",false,false);this.document.execCommand("enableInlineTableEditing",false,false)}catch(t){}}if(this.opts.focus)setTimeout(e.proxy(this.focus,this),100);if(!this.opts.visual){setTimeout(e.proxy(function(){this.opts.visual=true;this.toggle(false)},this),200)}this.callback("init")},buildBindKeyboard:function(){this.dblEnter=0;if(this.opts.dragUpload&&this.opts.imageUpload!==false){this.$editor.on("drop.redactor",e.proxy(this.buildEventDrop,this))}this.$editor.on("input.redactor",e.proxy(this.sync,this));this.$editor.on("paste.redactor",e.proxy(this.buildEventPaste,this));this.$editor.on("keydown.redactor",e.proxy(this.buildEventKeydown,this));this.$editor.on("keyup.redactor",e.proxy(this.buildEventKeyup,this));if(e.isFunction(this.opts.textareaKeydownCallback)){this.$source.on("keydown.redactor-textarea",e.proxy(this.opts.textareaKeydownCallback,this))}if(e.isFunction(this.opts.focusCallback)){this.$editor.on("focus.redactor",e.proxy(this.opts.focusCallback,this))}var t;e(document).mousedown(function(n){t=e(n.target)});this.$editor.on("blur.redactor",e.proxy(function(n){if(!e(t).hasClass("redactor_toolbar")&&e(t).parents(".redactor_toolbar").size()==0){this.selectall=false;if(e.isFunction(this.opts.blurCallback))this.callback("blur",n)}},this))},buildEventDrop:function(t){t=t.originalEvent||t;if(window.FormData===undefined||!t.dataTransfer)return true;var n=t.dataTransfer.files.length;if(n==0)return true;t.preventDefault();var r=t.dataTransfer.files[0];if(this.opts.dnbImageTypes!==false&&this.opts.dnbImageTypes.indexOf(r.type)==-1){return true}this.bufferSet();var i=e('<div id="redactor-progress"><span></span></div>');e(document.body).append(i);if(this.opts.s3===false){this.dragUploadAjax(this.opts.imageUpload,r,true,i,t,this.opts.imageUploadParam)}else{this.s3uploadFile(r)}},buildEventPaste:function(t){var n=false;if(this.browser("webkit")&&navigator.userAgent.indexOf("Chrome")===-1){var r=this.browser("version").split(".");if(r[0]<536)n=true}if(n)return true;if(this.browser("opera"))return true;if(this.opts.clipboardUpload&&this.buildEventClipboardUpload(t))return true;if(this.opts.cleanup){this.rtePaste=true;this.selectionSave();if(!this.selectall){if(this.opts.autoresize===true&&this.fullscreen!==true){this.$editor.height(this.$editor.height());this.saveScroll=this.document.documentElement.scrollTop}else{this.saveScroll=this.$editor.scrollTop()}}var i=this.extractContent();setTimeout(e.proxy(function(){var e=this.extractContent();this.$editor.append(i);this.selectionRestore();var t=this.getFragmentHtml(e);this.pasteClean(t);if(this.opts.autoresize===true&&this.fullscreen!==true)this.$editor.css("height","auto")},this),1)}},buildEventClipboardUpload:function(t){var n=t.originalEvent||t;this.clipboardFilePaste=false;if(typeof n.clipboardData==="undefined")return false;if(n.clipboardData.items){var r=n.clipboardData.items[0].getAsFile();if(r!==null){this.bufferSet();this.clipboardFilePaste=true;var i=new FileReader;i.onload=e.proxy(this.pasteClipboardUpload,this);i.readAsDataURL(r);return true}}return false},buildEventKeydown:function(t){if(this.rtePaste)return false;var n=t.which;var r=t.ctrlKey||t.metaKey;var i=this.getParent();var s=this.getCurrent();var o=this.getBlock();var u=false;this.callback("keydown",t);this.imageResizeHide(false);if(i&&e(i).get(0).tagName==="PRE"||s&&e(s).get(0).tagName==="PRE"){u=true;if(n===this.keyCode.DOWN)this.insertAfterLastElement(o)}if(n===this.keyCode.DOWN){if(i&&e(i)[0].tagName==="BLOCKQUOTE")this.insertAfterLastElement(i);if(s&&e(s)[0].tagName==="BLOCKQUOTE")this.insertAfterLastElement(s);if(i&&e(i)[0].tagName==="P"&&e(i).parent()[0].tagName=="BLOCKQUOTE"){this.insertAfterLastElement(i,e(i).parent()[0])}if(s&&e(s)[0].tagName==="P"&&i&&e(i)[0].tagName=="BLOCKQUOTE"){this.insertAfterLastElement(s,i)}}if(r&&!t.shiftKey)this.shortcuts(t,n);if(r&&n===90&&!t.shiftKey&&!t.altKey){t.preventDefault();if(this.opts.buffer.length)this.bufferUndo();else this.document.execCommand("undo",false,false);return}else if(r&&n===90&&t.shiftKey&&!t.altKey){t.preventDefault();if(this.opts.rebuffer.length!=0)this.bufferRedo();else this.document.execCommand("redo",false,false);return}if(n==32){this.bufferSet()}if(r&&n===65){this.bufferSet();this.selectall=true}else if(n!=this.keyCode.LEFT_WIN&&!r)this.selectall=false;if(n==this.keyCode.ENTER&&!t.shiftKey&&!t.ctrlKey&&!t.metaKey){if(this.browser("msie")&&i.nodeType==1&&(i.tagName=="TD"||i.tagName=="TH")){t.preventDefault();this.bufferSet();this.insertNode(document.createElement("br"));this.callback("enter",t);return false}if(o&&(o.tagName=="BLOCKQUOTE"||e(o).parent()[0].tagName=="BLOCKQUOTE")){if(this.isEndOfElement()){if(this.dblEnter==1){var a;var f;if(o.tagName=="BLOCKQUOTE"){f="br";a=o}else{f="p";a=e(o).parent()[0]}t.preventDefault();this.insertingAfterLastElement(a);this.dblEnter=0;if(f=="p"){e(o).parent().find("p").last().remove()}else{var l=e.trim(e(o).html());e(o).html(l.replace(/<br\s?\/?>$/i,""))}return}else this.dblEnter++}else this.dblEnter++}if(u===true)return this.buildEventKeydownPre(t,s);else{if(!this.opts.linebreaks){if(o&&this.opts.rBlockTest.test(o.tagName)){this.bufferSet();setTimeout(e.proxy(function(){var t=this.getBlock();if(t.tagName==="DIV"&&!e(t).hasClass("redactor_editor")){var n=e("<p>"+this.opts.invisibleSpace+"</p>");e(t).replaceWith(n);this.selectionStart(n)}},this),1)}else if(o===false){this.bufferSet();var c=e("<p>"+this.opts.invisibleSpace+"</p>");this.insertNode(c[0]);this.selectionStart(c);this.callback("enter",t);return false}}if(this.opts.linebreaks){if(o&&this.opts.rBlockTest.test(o.tagName)){this.bufferSet();setTimeout(e.proxy(function(){var t=this.getBlock();if((t.tagName==="DIV"||t.tagName==="P")&&!e(t).hasClass("redactor_editor")){this.replaceLineBreak(t)}},this),1)}else{return this.buildEventKeydownInsertLineBreak(t)}}if(o.tagName=="BLOCKQUOTE"||o.tagName=="FIGCAPTION"){return this.buildEventKeydownInsertLineBreak(t)}}this.callback("enter",t)}else if(n===this.keyCode.ENTER&&(t.ctrlKey||t.shiftKey)){this.bufferSet();t.preventDefault();this.insertLineBreak()}if(n===this.keyCode.TAB&&this.opts.shortcuts){return this.buildEventKeydownTab(t,u,n)}if(n===this.keyCode.BACKSPACE)this.buildEventKeydownBackspace(s)},buildEventKeydownPre:function(t,n){t.preventDefault();this.bufferSet();var r=e(n).parent().text();this.insertNode(document.createTextNode("\n"));if(r.search(/\s$/)==-1){this.insertNode(document.createTextNode("\n"))}this.sync();this.callback("enter",t);return false},buildEventKeydownTab:function(e,t,n){if(!this.opts.tabFocus)return true;if(this.isEmpty(this.get())&&this.opts.tabSpaces===false)return true;e.preventDefault();if(t===true&&!e.shiftKey){this.bufferSet();this.insertNode(document.createTextNode("	"));this.sync();return false}else if(this.opts.tabSpaces!==false){this.bufferSet();this.insertNode(document.createTextNode(Array(this.opts.tabSpaces+1).join(" ")));this.sync();return false}else{if(!e.shiftKey)this.indentingIndent();else this.indentingOutdent()}return false},buildEventKeydownBackspace:function(t){if(typeof t.tagName!=="undefined"&&/^(H[1-6])$/i.test(t.tagName)){var n;if(this.opts.linebreaks===false)n=e("<p>"+this.opts.invisibleSpace+"</p>");else n=e("<br>"+this.opts.invisibleSpace);e(t).replaceWith(n);this.selectionStart(n)}if(typeof t.nodeValue!=="undefined"&&t.nodeValue!==null){if(t.remove&&t.nodeType===3&&t.nodeValue.match(/[^\u200B]/g)==null){t.remove()}}},buildEventKeydownInsertLineBreak:function(e){this.bufferSet();e.preventDefault();this.insertLineBreak();this.callback("enter",e);return},buildEventKeyup:function(t){if(this.rtePaste)return false;var n=t.which;var r=this.getParent();var i=this.getCurrent();if(!this.opts.linebreaks&&i.nodeType==3&&(r==false||r.tagName=="BODY")){var s=e("<p>").append(e(i).clone());e(i).replaceWith(s);var o=e(s).next();if(typeof o[0]!=="undefined"&&o[0].tagName=="BR"){o.remove()}this.selectionEnd(s)}if((this.opts.convertLinks||this.opts.convertImageLinks||this.opts.convertVideoLinks)&&n===this.keyCode.ENTER){this.buildEventKeyupConverters()}if(n===this.keyCode.DELETE||n===this.keyCode.BACKSPACE){return this.formatEmpty(t)}this.callback("keyup",t);this.sync()},buildEventKeyupConverters:function(){this.formatLinkify(this.opts.linkProtocol,this.opts.convertLinks,this.opts.convertImageLinks,this.opts.convertVideoLinks,this.opts.linkSize);setTimeout(e.proxy(function(){if(this.opts.convertImageLinks)this.observeImages();if(this.opts.observeLinks)this.observeLinks()},this),5)},buildPlugins:function(){if(!this.opts.plugins)return;e.each(this.opts.plugins,e.proxy(function(t,n){if(RedactorPlugins[n]){e.extend(this,RedactorPlugins[n]);if(e.isFunction(RedactorPlugins[n].init))this.init()}},this))},iframeStart:function(){this.iframeCreate();if(this.opts.textareamode)this.iframeAppend(this.$source);else{this.$sourceOld=this.$source.hide();this.$source=this.buildCodearea(this.$sourceOld);this.iframeAppend(this.$sourceOld)}},iframeAppend:function(e){this.$source.attr("dir",this.opts.direction).hide();this.$box.insertAfter(e).append(this.$frame).append(this.$source)},iframeCreate:function(){this.$frame=e('<iframe style="width: 100%;" frameborder="0" />').one("load",e.proxy(function(){if(this.opts.fullpage){this.iframePage();if(this.content==="")this.content=this.opts.invisibleSpace;this.$frame.contents()[0].write(this.content);this.$frame.contents()[0].close();var t=setInterval(e.proxy(function(){if(this.$frame.contents().find("body").html()){clearInterval(t);this.iframeLoad()}},this),0)}else this.iframeLoad()},this))},iframeDoc:function(){return this.$frame[0].contentWindow.document},iframePage:function(){var e=this.iframeDoc();if(e.documentElement)e.removeChild(e.documentElement);return e},iframeAddCss:function(t){t=t||this.opts.css;if(this.isString(t)){this.$frame.contents().find("head").append('<link rel="stylesheet" href="'+t+'" />')}if(e.isArray(t)){e.each(t,e.proxy(function(e,t){this.iframeAddCss(t)},this))}},iframeLoad:function(){this.$editor=this.$frame.contents().find("body").attr({contenteditable:true,dir:this.opts.direction});if(this.$editor[0]){this.document=this.$editor[0].ownerDocument;this.window=this.document.defaultView||window}this.iframeAddCss();if(this.opts.fullpage)this.setFullpageOnInit(this.$editor.html());else this.set(this.content,true,false);this.buildOptions();this.buildAfter()},placeholderStart:function(e){if(this.isEmpty(e)){if(this.$element.attr("placeholder"))this.opts.placeholder=this.$element.attr("placeholder");if(this.opts.placeholder==="")this.opts.placeholder=false;if(this.opts.placeholder!==false){this.opts.focus=false;this.placeholderEvents();return this.placeholderGet()}}return false},placeholderEvents:function(){this.$editor.on("focus.redactor_placeholder",e.proxy(this.placeholderFocus,this));this.$editor.on("blur.redactor_placeholder",e.proxy(this.placeholderBlur,this))},placeholderGet:function(){return e('<span class="redactor_placeholder">').data("redactor","verified").attr("contenteditable",false).text(this.opts.placeholder)},placeholderBlur:function(){var t=this.get();if(this.isEmpty(t)){this.$editor.on("focus.redactor_placeholder",e.proxy(this.placeholderFocus,this));this.$editor.html(this.placeholderGet())}},placeholderFocus:function(){this.$editor.find("span.redactor_placeholder").remove();var e="";if(this.opts.linebreaks===false)e=this.opts.emptyHtml;this.$editor.off("focus.redactor_placeholder");this.$editor.html(e);if(this.opts.linebreaks===false){this.selectionStart(this.$editor.children()[0])}else{this.focus()}this.sync()},placeholderRemove:function(){this.opts.placeholder=false;this.$editor.find("span.redactor_placeholder").remove();this.$editor.off("focus.redactor_placeholder")},placeholderRemoveFromCode:function(e){return e.replace(/<span class="redactor_placeholder"(.*?)>(.*?)<\/span>/i,"")},shortcuts:function(e,t){if(!this.opts.shortcuts)return;if(!e.altKey){if(t===77)this.shortcutsLoad(e,"removeFormat");else if(t===66)this.shortcutsLoad(e,"bold");else if(t===73)this.shortcutsLoad(e,"italic");else if(t===74)this.shortcutsLoad(e,"insertunorderedlist");else if(t===75)this.shortcutsLoad(e,"insertorderedlist");else if(t===72)this.shortcutsLoad(e,"superscript");else if(t===76)this.shortcutsLoad(e,"subscript")}else{if(t===48)this.shortcutsLoadFormat(e,"p");else if(t===49)this.shortcutsLoadFormat(e,"h1");else if(t===50)this.shortcutsLoadFormat(e,"h2");else if(t===51)this.shortcutsLoadFormat(e,"h3");else if(t===52)this.shortcutsLoadFormat(e,"h4");else if(t===53)this.shortcutsLoadFormat(e,"h5");else if(t===54)this.shortcutsLoadFormat(e,"h6")}},shortcutsLoad:function(e,t){e.preventDefault();this.execCommand(t,false)},shortcutsLoadFormat:function(e,t){e.preventDefault();this.formatBlocks(t)},focus:function(){if(!this.browser("opera")){this.window.setTimeout(e.proxy(this.focusSet,this,true),1)}else{this.$editor.focus()}},focusWithSaveScroll:function(){if(this.browser("msie")){var e=this.document.documentElement.scrollTop}this.$editor.focus();if(this.browser("msie")){this.document.documentElement.scrollTop=e}},focusEnd:function(){if(!this.browser("mozilla")){this.focusSet()}else{if(this.opts.linebreaks===false){var e=this.$editor.children().last();this.$editor.focus();this.selectionEnd(e)}else{this.focusSet()}}},focusSet:function(e,t){this.$editor.focus();if(typeof t=="undefined"){t=this.$editor[0]}var n=this.getRange();n.selectNodeContents(t);n.collapse(e||false);var r=this.getSelection();r.removeAllRanges();r.addRange(n)},toggle:function(e){if(this.opts.visual)this.toggleCode(e);else this.toggleVisual()},toggleVisual:function(){var e=this.$source.hide().val();if(typeof this.modified!=="undefined"){this.modified=this.cleanRemoveSpaces(this.modified,false)!==this.cleanRemoveSpaces(e,false)}if(this.modified){if(this.opts.fullpage&&e==="")this.setFullpageOnInit(e);else{this.set(e);if(this.opts.fullpage)this.buildBindKeyboard()}}if(this.opts.iframe)this.$frame.show();else this.$editor.show();if(this.opts.fullpage)this.$editor.attr("contenteditable",true);this.$source.off("keydown.redactor-textarea-indenting");this.$editor.focus();this.selectionRestore();this.observeStart();this.buttonActiveVisual();this.buttonInactive("html");this.opts.visual=true},toggleCode:function(e){if(e!==false)this.selectionSave();var t=null;if(this.opts.iframe){t=this.$frame.height();if(this.opts.fullpage)this.$editor.removeAttr("contenteditable");this.$frame.hide()}else{t=this.$editor.innerHeight();this.$editor.hide()}var n=this.$source.val();if(n!==""&&this.opts.tidyHtml){this.$source.val(this.cleanHtml(n))}this.modified=n;this.$source.height(t).show().focus();this.$source.on("keydown.redactor-textarea-indenting",this.textareaIndenting);this.buttonInactiveVisual();this.buttonActive("html");this.opts.visual=false},textareaIndenting:function(t){if(t.keyCode===9){var n=e(this);var r=n.get(0).selectionStart;n.val(n.val().substring(0,r)+"	"+n.val().substring(n.get(0).selectionEnd));n.get(0).selectionStart=n.get(0).selectionEnd=r+1;return false}},autosave:function(){var t=false;this.autosaveInterval=setInterval(e.proxy(function(){var n=this.get();if(t!==n){e.ajax({url:this.opts.autosave,type:"post",data:this.$source.attr("name")+"="+escape(encodeURIComponent(n)),success:e.proxy(function(e){this.callback("autosave",false,e);t=n},this)})}},this),this.opts.autosaveInterval*1e3)},toolbarBuild:function(){if(this.isMobile()&&this.opts.buttonsHideOnMobile.length>0){e.each(this.opts.buttonsHideOnMobile,e.proxy(function(e,t){var n=this.opts.buttons.indexOf(t);this.opts.buttons.splice(n,1)},this))}if(this.opts.air){this.opts.buttons=this.opts.airButtons}else{if(!this.opts.buttonSource){var t=this.opts.buttons.indexOf("html");this.opts.buttons.splice(t,1)}}if(this.opts.toolbar){e.each(this.opts.toolbar.formatting.dropdown,e.proxy(function(t,n){if(e.inArray(t,this.opts.formattingTags)=="-1")delete this.opts.toolbar.formatting.dropdown[t]},this))}if(this.opts.buttons.length===0)return false;this.airEnable();this.$toolbar=e("<ul>").addClass("redactor_toolbar").attr("id","redactor_toolbar_"+this.uuid);if(this.opts.typewriter){this.$toolbar.addClass("redactor-toolbar-typewriter")}if(this.opts.toolbarOverflow&&this.isMobile()){this.$toolbar.addClass("redactor-toolbar-overflow")}if(this.opts.air){this.$air=e('<div class="redactor_air">').attr("id","redactor_air_"+this.uuid).hide();this.$air.append(this.$toolbar);e("body").append(this.$air)}else{if(this.opts.toolbarExternal){this.$toolbar.addClass("redactor-toolbar-external");e(this.opts.toolbarExternal).html(this.$toolbar)}else this.$box.prepend(this.$toolbar)}e.each(this.opts.buttons,e.proxy(function(t,n){if(this.opts.toolbar[n]){var r=this.opts.toolbar[n];if(this.opts.fileUpload===false&&n==="file")return true;this.$toolbar.append(e("<li>").append(this.buttonBuild(n,r)))}},this));this.$toolbar.find("a").attr("tabindex","-1");if(this.opts.toolbarFixed){this.toolbarObserveScroll();e(this.opts.toolbarFixedTarget).on("scroll.redactor",e.proxy(this.toolbarObserveScroll,this))}if(this.opts.activeButtons){this.$editor.on("mouseup.redactor keyup.redactor",e.proxy(this.buttonActiveObserver,this))}},toolbarObserveScroll:function(){var t=e(this.opts.toolbarFixedTarget).scrollTop();var n=this.$box.offset().top;var r=0;var i=n+this.$box.height()+40;if(t>n){var s="100%";if(this.opts.toolbarFixedBox){r=this.$box.offset().left;s=this.$box.innerWidth();this.$toolbar.addClass("toolbar_fixed_box")}this.toolbarFixed=true;this.$toolbar.css({position:"fixed",width:s,zIndex:1005,top:this.opts.toolbarFixedTopOffset+"px",left:r});if(t<i)this.$toolbar.css("visibility","visible");else this.$toolbar.css("visibility","hidden")}else{this.toolbarFixed=false;this.$toolbar.css({position:"relative",width:"auto",top:0,left:r});if(this.opts.toolbarFixedBox)this.$toolbar.removeClass("toolbar_fixed_box")}},airEnable:function(){if(!this.opts.air)return;this.$editor.on("mouseup.redactor keyup.redactor",this,e.proxy(function(t){var n=this.getSelectionText();if(t.type==="mouseup"&&n!="")this.airShow(t);if(t.type==="keyup"&&t.shiftKey&&n!=""){var r=e(this.getElement(this.getSelection().focusNode)),i=r.offset();i.height=r.height();this.airShow(i,true)}},this))},airShow:function(t,n){if(!this.opts.air)return;var r,i;e(".redactor_air").hide();if(n){r=t.left;i=t.top+t.height+14;if(this.opts.iframe){i+=this.$box.position().top-e(this.document).scrollTop();r+=this.$box.position().left}}else{var s=this.$air.innerWidth();r=t.clientX;if(e(this.document).width()<r+s)r-=s;i=t.clientY+14;if(this.opts.iframe){i+=this.$box.position().top;r+=this.$box.position().left}else i+=e(this.document).scrollTop()}this.$air.css({left:r+"px",top:i+"px"}).show();this.airBindHide()},airBindHide:function(){if(!this.opts.air)return;var t=e.proxy(function(t){e(t).on("mousedown.redactor",e.proxy(function(n){if(e(n.target).closest(this.$toolbar).length===0){this.$air.fadeOut(100);this.selectionRemove();e(t).off(n)}},this)).on("keydown.redactor",e.proxy(function(n){if(n.which===this.keyCode.ESC){this.getSelection().collapseToStart()}this.$air.fadeOut(100);e(t).off(n)},this))},this);t(document);if(this.opts.iframe)t(this.document)},airBindMousemoveHide:function(){if(!this.opts.air)return;var t=e.proxy(function(t){e(t).on("mousemove.redactor",e.proxy(function(n){if(e(n.target).closest(this.$toolbar).length===0){this.$air.fadeOut(100);e(t).off(n)}},this))},this);t(document);if(this.opts.iframe)t(this.document)},dropdownBuild:function(t,n){e.each(n,e.proxy(function(n,r){if(!r.className)r.className="";var i;if(r.name==="separator")i=e('<a class="redactor_separator_drop">');else{i=e('<a href="#" class="'+r.className+" redactor_dropdown_"+n+'">'+r.title+"</a>");i.on("click",e.proxy(function(e){if(e.preventDefault)e.preventDefault();if(this.browser("msie"))e.returnValue=false;if(r.callback)r.callback.call(this,n,i,r,e);if(r.exec)this.execCommand(r.exec,n);if(r.func)this[r.func](n);this.buttonActiveObserver();if(this.opts.air)this.$air.fadeOut(100)},this))}t.append(i)},this))},dropdownShow:function(t,n){if(!this.opts.visual){t.preventDefault();return false}var r=this.$toolbar.find(".redactor_dropdown_box_"+n);var i=this.buttonGet(n);if(i.hasClass("dropact"))this.dropdownHideAll();else{this.dropdownHideAll();this.buttonActive(n);i.addClass("dropact");var s=i.position();if(this.toolbarFixed){s=i.offset()}var o=r.width();if(s.left+o>e(document).width()){s.left-=o}var u=s.left+"px";var a=i.innerHeight();var f="absolute";var l=a+"px";if(this.opts.toolbarFixed&&this.toolbarFixed)f="fixed";else if(!this.opts.air)l=s.top+a+"px";r.css({position:f,left:u,top:l}).show()}var c=e.proxy(function(e){this.dropdownHide(e,r)},this);e(document).one("click",c);this.$editor.one("click",c);t.stopPropagation();this.focusWithSaveScroll()},dropdownHideAll:function(){this.$toolbar.find("a.dropact").removeClass("redactor_act").removeClass("dropact");e(".redactor_dropdown").hide()},dropdownHide:function(t,n){if(!e(t.target).hasClass("dropact")){n.removeClass("dropact");this.dropdownHideAll()}},buttonBuild:function(t,n,r){var i=e('<a href="javascript:;" title="'+n.title+'" tabindex="-1" class="re-icon re-'+t+'"></a>');if(typeof r!="undefined"){i.addClass("redactor-btn-image")}i.on("click",e.proxy(function(e){if(e.preventDefault)e.preventDefault();if(this.browser("msie"))e.returnValue=false;if(i.hasClass("redactor_button_disabled"))return false;if(this.isFocused()===false&&!n.exec){this.focusWithSaveScroll()}if(n.exec){this.focusWithSaveScroll();this.execCommand(n.exec,t);this.airBindMousemoveHide()}else if(n.func&&n.func!=="show"){this[n.func](t);this.airBindMousemoveHide()}else if(n.callback){n.callback.call(this,t,i,n,e);this.airBindMousemoveHide()}else if(n.dropdown){this.dropdownShow(e,t)}this.buttonActiveObserver(false,t)},this));if(n.dropdown){var s=e('<div class="redactor_dropdown redactor_dropdown_box_'+t+'" style="display: none;">');s.appendTo(this.$toolbar);this.dropdownBuild(s,n.dropdown)}return i},buttonGet:function(t){if(!this.opts.toolbar)return false;return e(this.$toolbar.find("a.re-"+t))},buttonTagToActiveState:function(e,t){this.opts.activeButtons.push(e);this.opts.activeButtonsStates[t]=e},buttonActiveToggle:function(e){var t=this.buttonGet(e);if(t.hasClass("redactor_act")){this.buttonInactive(e)}else{this.buttonActive(e)}},buttonActive:function(e){var t=this.buttonGet(e);t.addClass("redactor_act")},buttonInactive:function(e){var t=this.buttonGet(e);t.removeClass("redactor_act")},buttonInactiveAll:function(e){this.$toolbar.find("a.re-icon").not(".re-"+e).removeClass("redactor_act")},buttonActiveVisual:function(){this.$toolbar.find("a.re-icon").not("a.re-html").removeClass("redactor_button_disabled")},buttonInactiveVisual:function(){this.$toolbar.find("a.re-icon").not("a.re-html").addClass("redactor_button_disabled")},buttonChangeIcon:function(e,t){this.buttonGet(e).addClass("re-"+t)},buttonRemoveIcon:function(e,t){this.buttonGet(e).removeClass("re-"+t)},buttonAwesome:function(e,t){var n=this.buttonGet(e);n.removeClass("redactor-btn-image");n.addClass("fa-redactor-btn");n.html('<i class="fa '+t+'"></i>')},buttonAdd:function(t,n,r,i){if(!this.opts.toolbar)return;var s=this.buttonBuild(t,{title:n,callback:r,dropdown:i},true);this.$toolbar.append(e("<li>").append(s))},buttonAddFirst:function(t,n,r,i){if(!this.opts.toolbar)return;var s=this.buttonBuild(t,{title:n,callback:r,dropdown:i},true);this.$toolbar.prepend(e("<li>").append(s))},buttonAddAfter:function(t,n,r,i,s){if(!this.opts.toolbar)return;var o=this.buttonBuild(n,{title:r,callback:i,dropdown:s},true);var u=this.buttonGet(t);if(u.size()!==0)u.parent().after(e("<li>").append(o));else this.$toolbar.append(e("<li>").append(o))},buttonAddBefore:function(t,n,r,i,s){if(!this.opts.toolbar)return;var o=this.buttonBuild(n,{title:r,callback:i,dropdown:s},true);var u=this.buttonGet(t);if(u.size()!==0)u.parent().before(e("<li>").append(o));else this.$toolbar.append(e("<li>").append(o))},buttonRemove:function(e){var t=this.buttonGet(e);t.remove()},buttonActiveObserver:function(t,n){var r=this.getParent();this.buttonInactiveAll(n);if(t===false&&n!=="html"){if(e.inArray(n,this.opts.activeButtons)!=-1){this.buttonActiveToggle(n)}return}if(r&&r.tagName==="A")this.$toolbar.find("a.redactor_dropdown_link").text(this.opts.curLang.link_edit);else this.$toolbar.find("a.redactor_dropdown_link").text(this.opts.curLang.link_insert);e.each(this.opts.activeButtonsStates,e.proxy(function(t,n){if(e(r).closest(t,this.$editor.get()[0]).length!=0){this.buttonActive(n)}},this));var i=e(r).closest(this.opts.alignmentTags.toString().toLowerCase(),this.$editor[0]);if(i.length){var s=i.css("text-align");switch(s){case"right":this.buttonActive("alignright");break;case"center":this.buttonActive("aligncenter");break;case"justify":this.buttonActive("alignjustify");break;default:this.buttonActive("alignleft");break}}},execPasteFrag:function(e){var t=this.window.getSelection();if(t.getRangeAt&&t.rangeCount){range=t.getRangeAt(0);range.deleteContents();var n=document.createElement("div");n.innerHTML=e;var r=document.createDocumentFragment(),i,s;while(i=n.firstChild){s=r.appendChild(i)}var o=r.firstChild;range.insertNode(r);if(s){range=range.cloneRange();range.setStartAfter(s);range.collapse(true)}t.removeAllRanges();t.addRange(range)}},exec:function(e,t,n){if(e==="formatblock"&&this.browser("msie"))t="<"+t+">";if(e==="inserthtml"&&this.browser("msie")){if(!this.isIe11()){this.focusWithSaveScroll();this.document.selection.createRange().pasteHTML(t)}else this.execPasteFrag(t)}else{this.document.execCommand(e,false,t)}if(n!==false)this.sync();this.callback("execCommand",e,t)},execCommand:function(e,t,n){if(!this.opts.visual){this.$source.focus();return false}if(e==="superscript"||e==="subscript"){var r=this.getParent();if(r.tagName==="SUP"||r.tagName==="SUB"){this.inlineRemoveFormatReplace(r)}}if(e==="inserthtml"){this.insertHtml(t,n);this.callback("execCommand",e,t);return}if(this.currentOrParentIs("PRE")&&!this.opts.formattingPre)return false;if(e==="insertunorderedlist"||e==="insertorderedlist")return this.execLists(e,t);if(e==="unlink")return this.execUnlink(e,t);this.exec(e,t,n);if(e==="inserthorizontalrule")this.$editor.find("hr").removeAttr("id")},execUnlink:function(t,n){this.bufferSet();var r=this.currentOrParentIs("A");if(r){e(r).replaceWith(e(r).text());this.sync();this.callback("execCommand",t,n);return}},execLists:function(t,n){this.bufferSet();var r=this.getParent();var i=e(r).closest("ol, ul");if(!this.isParentRedactor(i)&&i.size()!=0){i=false}var s=false;if(i&&i.length){s=true;var o=i[0].tagName;if(t==="insertunorderedlist"&&o==="OL"||t==="insertorderedlist"&&o==="UL"){s=false}}this.selectionSave();if(s){var u=this.getNodes();var a=this.getBlocks(u);if(typeof u[0]!="undefined"&&u.length>1&&u[0].nodeType==3){a.unshift(this.getBlock())}var f="",l="";e.each(a,e.proxy(function(t,n){if(n.tagName=="LI"){var r=e(n);var i=r.clone();i.find("ul","ol").remove();if(this.opts.linebreaks===false){f+=this.outerHtml(e("<p>").append(i.contents()))}else{f+=i.html()+"<br>"}if(t==0){r.addClass("redactor-replaced").empty();l=this.outerHtml(r)}else r.remove()}},this));html=this.$editor.html().replace(l,"</"+o+">"+f+"<"+o+">");this.$editor.html(html);this.$editor.find(o+":empty").remove()}else{var c=e(this.getParent()).closest("td");this.document.execCommand(t);var r=this.getParent();var i=e(r).closest("ol, ul");if(c.size()!=0){i.wrapAll("<td>")}if(i.length){var h=i.parent();if(this.isParentRedactor(h)&&h[0].tagName!="LI"&&this.nodeTestBlocks(h[0])){h.replaceWith(h.contents())}}if(this.browser("mozilla")){this.$editor.focus()}}this.selectionRestore();this.sync();this.callback("execCommand",t,n);return},indentingIndent:function(){this.indentingStart("indent")},indentingOutdent:function(){this.indentingStart("outdent")},indentingStart:function(t){this.bufferSet();if(t==="indent"){var n=this.getBlock();this.selectionSave();if(n&&n.tagName=="LI"){var r=this.getParent();var i=e(r).closest("ol, ul");var s=i[0].tagName;var o=this.getBlocks();e.each(o,function(t,n){if(n.tagName=="LI"){var r=e(n).prev();if(r.size()!=0&&r[0].tagName=="LI"){var i=r.children("ul, ol");if(i.size()==0){r.append(e("<"+s+">").append(n))}else i.append(n)}}})}else if(n===false&&this.opts.linebreaks===true){this.exec("formatBlock","blockquote");var u=this.getBlock();var n=e('<div data-tagblock="">').html(e(u).html());e(u).replaceWith(n);var a=this.normalize(e(n).css("margin-left"))+this.opts.indentValue;e(n).css("margin-left",a+"px")}else{var f=this.getBlocks();e.each(f,e.proxy(function(t,n){var r=false;if(n.tagName==="TD")return;if(e.inArray(n.tagName,this.opts.alignmentTags)!==-1){r=e(n)}else{r=e(n).closest(this.opts.alignmentTags.toString().toLowerCase(),this.$editor[0])}var i=this.normalize(r.css("margin-left"))+this.opts.indentValue;r.css("margin-left",i+"px")},this))}this.selectionRestore()}else{this.selectionSave();var n=this.getBlock();if(n&&n.tagName=="LI"){var o=this.getBlocks();var l=0;this.insideOutdent(n,l,o)}else{var f=this.getBlocks();e.each(f,e.proxy(function(t,n){var r=false;if(e.inArray(n.tagName,this.opts.alignmentTags)!==-1){r=e(n)}else{r=e(n).closest(this.opts.alignmentTags.toString().toLowerCase(),this.$editor[0])}var i=this.normalize(r.css("margin-left"))-this.opts.indentValue;if(i<=0){if(this.opts.linebreaks===true&&typeof r.data("tagblock")!=="undefined"){r.replaceWith(r.html())}else{r.css("margin-left","");this.removeEmptyAttr(r,"style")}}else{r.css("margin-left",i+"px")}},this))}this.selectionRestore()}this.sync()},insideOutdent:function(t,n,r){if(t&&t.tagName=="LI"){var i=e(t).parent().parent();if(i.size()!=0&&i[0].tagName=="LI"){i.after(t)}else{if(typeof r[n]!="undefined"){t=r[n];n++;this.insideOutdent(t,n,r)}else{this.execCommand("insertunorderedlist")}}}},alignmentLeft:function(){this.alignmentSet("","JustifyLeft")},alignmentRight:function(){this.alignmentSet("right","JustifyRight")},alignmentCenter:function(){this.alignmentSet("center","JustifyCenter")},alignmentJustify:function(){this.alignmentSet("justify","JustifyFull")},alignmentSet:function(t,n){this.bufferSet();if(this.oldIE()){this.document.execCommand(n,false,false);return true}this.selectionSave();var r=this.getBlock();if(!r&&this.opts.linebreaks){this.exec("formatBlock","blockquote");var i=this.getBlock();var r=e('<div data-tagblock="">').html(e(i).html());e(i).replaceWith(r);e(r).css("text-align",t);this.removeEmptyAttr(r,"style");if(t==""&&typeof e(r).data("tagblock")!=="undefined"){e(r).replaceWith(e(r).html())}}else{var s=this.getBlocks();e.each(s,e.proxy(function(n,r){var i=false;if(e.inArray(r.tagName,this.opts.alignmentTags)!==-1){i=e(r)}else{i=e(r).closest(this.opts.alignmentTags.toString().toLowerCase(),this.$editor[0])}if(i){i.css("text-align",t);this.removeEmptyAttr(i,"style")}},this))}this.selectionRestore();this.sync()},cleanEmpty:function(e){var t=this.placeholderStart(e);if(t!==false)return t;if(this.opts.linebreaks===false){if(e==="")e=this.opts.emptyHtml;else if(e.search(/^<hr\s?\/?>$/gi)!==-1)e="<hr>"+this.opts.emptyHtml}return e},cleanConverters:function(e){if(this.opts.convertDivs)e=e.replace(/<div(.*?)>([\w\W]*?)<\/div>/gi,"<p$1>$2</p>");if(this.opts.paragraphy)e=this.cleanParagraphy(e);return e},cleanConvertProtected:function(e){if(this.opts.templateVars){e=e.replace(/\{\{(.*?)\}\}/gi,"<!-- template double $1 -->");e=e.replace(/\{(.*?)\}/gi,"<!-- template $1 -->")}e=e.replace(/<script(.*?)>([\w\W]*?)<\/script>/gi,'<title type="text/javascript" style="display: none;" class="redactor-script-tag"$1>$2</title>');if(!this.opts.iframe){e=e.replace(/<style(.*?)>([\w\W]*?)<\/style>/gi,'<section$1 style="display: none;" rel="redactor-style-tag">$2</section>')}e=e.replace(/<form(.*?)>([\w\W]*?)<\/form>/gi,'<section$1 rel="redactor-form-tag">$2</section>');if(this.opts.phpTags)e=e.replace(/<\?php([\w\W]*?)\?>/gi,'<section style="display: none;" rel="redactor-php-tag">$1</section>');else e=e.replace(/<\?php([\w\W]*?)\?>/gi,"");return e},cleanReConvertProtected:function(e){if(this.opts.templateVars){e=e.replace(/<!-- template double (.*?) -->/gi,"{{$1}}");e=e.replace(/<!-- template (.*?) -->/gi,"{$1}")}e=e.replace(/<title type="text\/javascript" style="display: none;" class="redactor-script-tag"(.*?)>([\w\W]*?)<\/title>/gi,'<script$1 type="text/javascript">$2</script>');if(!this.opts.iframe){e=e.replace(/<section(.*?) style="display: none;" rel="redactor-style-tag">([\w\W]*?)<\/section>/gi,"<style$1>$2</style>")}e=e.replace(/<section(.*?)rel="redactor-form-tag"(.*?)>([\w\W]*?)<\/section>/gi,"<form$1$2>$3</form>");if(this.opts.phpTags)e=e.replace(/<section style="display: none;" rel="redactor-php-tag">([\w\W]*?)<\/section>/gi,"<?php\r\n$1\r\n?>");return e},cleanRemoveSpaces:function(t,n){if(n!==false){var n=[];var r=t.match(/<(pre|style|script|title)(.*?)>([\w\W]*?)<\/(pre|style|script|title)>/gi);if(r===null)r=[];if(this.opts.phpTags){var i=t.match(/<\?php([\w\W]*?)\?>/gi);if(i)r=e.merge(r,i)}if(r){e.each(r,function(e,r){t=t.replace(r,"buffer_"+e);n.push(r)})}}t=t.replace(/\n/g," ");t=t.replace(/[\t]*/g,"");t=t.replace(/\n\s*\n/g,"\n");t=t.replace(/^[\s\n]*/g," ");t=t.replace(/[\s\n]*$/g," ");t=t.replace(/>\s{2,}</g,"> <");t=this.cleanReplacer(t,n);t=t.replace(/\n\n/g,"\n");return t},cleanReplacer:function(t,n){if(n===false)return t;e.each(n,function(e,n){t=t.replace("buffer_"+e,n)});return t},cleanRemoveEmptyTags:function(e){e=e.replace(/<span>([\w\W]*?)<\/span>/gi,"$1");e=e.replace(/[\u200B-\u200D\uFEFF]/g,"");var t=["<b>\\s*</b>","<b>&nbsp;</b>","<em>\\s*</em>"];var n=["<pre></pre>","<blockquote>\\s*</blockquote>","<dd></dd>","<dt></dt>","<ul></ul>","<ol></ol>","<li></li>","<table></table>","<tr></tr>","<span>\\s*<span>","<span>&nbsp;<span>","<p>\\s*</p>","<p></p>","<p>&nbsp;</p>","<p>\\s*<br>\\s*</p>","<div>\\s*</div>","<div>\\s*<br>\\s*</div>"];if(this.opts.removeEmptyTags){n=n.concat(t)}else n=t;var r=n.length;for(var i=0;i<r;++i){e=e.replace(new RegExp(n[i],"gi"),"")}return e},cleanParagraphy:function(t){function o(e,n,r){return t.replace(new RegExp(e,n),r)}t=e.trim(t);if(this.opts.linebreaks===true)return t;if(t===""||t==="<p></p>")return this.opts.emptyHtml;t=t+"\n";var n=[];var r=t.match(/<(table|div|pre|object)(.*?)>([\w\W]*?)<\/(table|div|pre|object)>/gi);if(!r)r=[];var i=t.match(/<!--([\w\W]*?)-->/gi);if(i)r=e.merge(r,i);if(this.opts.phpTags){var s=t.match(/<section(.*?)rel="redactor-php-tag">([\w\W]*?)<\/section>/gi);if(s)r=e.merge(r,s)}if(r){e.each(r,function(e,r){n[e]=r;t=t.replace(r,"{replace"+e+"}\n")})}t=t.replace(/<br \/>\s*<br \/>/gi,"\n\n");var u="(comment|html|body|head|title|meta|style|script|link|iframe|table|thead|tfoot|caption|col|colgroup|tbody|tr|td|th|div|dl|dd|dt|ul|ol|li|pre|select|option|form|map|area|blockquote|address|math|style|p|h[1-6]|hr|fieldset|legend|section|article|aside|hgroup|header|footer|nav|figure|figcaption|details|menu|summary)";t=o("(<"+u+"[^>]*>)","gi","\n$1");t=o("(</"+u+">)","gi","$1\n\n");t=o("\r\n","g","\n");t=o("\r","g","\n");t=o("/\n\n+/","g","\n\n");var a=t.split(new RegExp("\ns*\n","g"),-1);t="";for(var f in a){if(a.hasOwnProperty(f)){if(a[f].search("{replace")==-1){a[f]=a[f].replace(/<p>\n\t<\/p>/gi,"");a[f]=a[f].replace(/<p><\/p>/gi,"");if(a[f]!=""){t+="<p>"+a[f].replace(/^\n+|\n+$/g,"")+"</p>"}}else t+=a[f]}}t=o("<p><p>","gi","<p>");t=o("</p></p>","gi","</p>");t=o("<p>s?</p>","gi","");t=o("<p>([^<]+)</(div|address|form)>","gi","<p>$1</p></$2>");t=o("<p>(</?"+u+"[^>]*>)</p>","gi","$1");t=o("<p>(<li.+?)</p>","gi","$1");t=o("<p>s?(</?"+u+"[^>]*>)","gi","$1");t=o("(</?"+u+"[^>]*>)s?</p>","gi","$1");t=o("(</?"+u+"[^>]*>)s?<br />","gi","$1");t=o("<br />(s*</?(?:p|li|div|dl|dd|dt|th|pre|td|ul|ol)[^>]*>)","gi","$1");t=o("\n</p>","gi","</p>");t=o("<li><p>","gi","<li>");t=o("</p></li>","gi","</li>");t=o("</li><p>","gi","</li>");t=o("<p>	?\n?<p>","gi","<p>");t=o("</dt><p>","gi","</dt>");t=o("</dd><p>","gi","</dd>");t=o("<br></p></blockquote>","gi","</blockquote>");t=o("<p>	*</p>","gi","");e.each(n,function(e,n){t=t.replace("{replace"+e+"}",n)});return e.trim(t)},cleanConvertInlineTags:function(e,t){var n="strong";if(this.opts.boldTag==="b")n="b";var r="em";if(this.opts.italicTag==="i")r="i";e=e.replace(/<span style="font-style: italic;">([\w\W]*?)<\/span>/gi,"<"+r+">$1</"+r+">");e=e.replace(/<span style="font-weight: bold;">([\w\W]*?)<\/span>/gi,"<"+n+">$1</"+n+">");if(this.opts.boldTag==="strong")e=e.replace(/<b>([\w\W]*?)<\/b>/gi,"<strong>$1</strong>");else e=e.replace(/<strong>([\w\W]*?)<\/strong>/gi,"<b>$1</b>");if(this.opts.italicTag==="em")e=e.replace(/<i>([\w\W]*?)<\/i>/gi,"<em>$1</em>");else e=e.replace(/<em>([\w\W]*?)<\/em>/gi,"<i>$1</i>");if(t!==true){e=e.replace(/<strike>([\w\W]*?)<\/strike>/gi,"<del>$1</del>")}else{e=e.replace(/<del>([\w\W]*?)<\/del>/gi,"<strike>$1</strike>")}return e},cleanStripTags:function(t){if(t==""||typeof t=="undefined")return t;var n=false;if(this.opts.allowedTags!==false)n=true;var r=n===true?this.opts.allowedTags:this.opts.deniedTags;var i=/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi;t=t.replace(i,function(t,i){if(n===true)return e.inArray(i.toLowerCase(),r)>"-1"?t:"";else return e.inArray(i.toLowerCase(),r)>"-1"?"":t});t=this.cleanConvertInlineTags(t);return t},cleanSavePreCode:function(t,n){var r=t.match(/<(pre|code)(.*?)>([\w\W]*?)<\/(pre|code)>/gi);if(r!==null){e.each(r,e.proxy(function(e,r){var i=r.match(/<(pre|code)(.*?)>([\w\W]*?)<\/(pre|code)>/i);i[3]=i[3].replace(/&nbsp;/g," ");if(n!==false)i[3]=this.cleanEncodeEntities(i[3]);i[3]=i[3].replace(/\$/g,"&#36;");t=t.replace(r,"<"+i[1]+i[2]+">"+i[3]+"</"+i[1]+">")},this))}return t},cleanEncodeEntities:function(e){e=String(e).replace(/&/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"');return e.replace(/&/g,"&").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},cleanUnverified:function(){var t=this.$editor.find("li, img, a, b, strong, sub, sup, i, em, u, small, strike, del, span, cite");t.filter('[style*="background-color: transparent;"][style*="line-height"]').css("background-color","").css("line-height","");t.filter('[style*="background-color: transparent;"]').css("background-color","");t.css("line-height","");e.each(t,e.proxy(function(e,t){this.removeEmptyAttr(t,"style")},this));this.$editor.find('div[style="text-align: -webkit-auto;"]').contents().unwrap()},cleanHtml:function(e){var t=0,n=e.length,r=0,i=null,s=null,o="",u="",a="";this.cleanlevel=0;for(;t<n;t++){r=t;if(-1==e.substr(t).indexOf("<")){u+=e.substr(t);return this.cleanFinish(u)}while(r<n&&e.charAt(r)!="<"){r++}if(t!=r){a=e.substr(t,r-t);if(!a.match(/^\s{2,}$/g)){if("\n"==u.charAt(u.length-1))u+=this.cleanGetTabs();else if("\n"==a.charAt(0)){u+="\n"+this.cleanGetTabs();a=a.replace(/^\s+/,"")}u+=a}if(a.match(/\n/))u+="\n"+this.cleanGetTabs()}i=r;while(r<n&&">"!=e.charAt(r)){r++}o=e.substr(i,r-i);t=r;var f;if("!--"==o.substr(1,3)){if(!o.match(/--$/)){while("-->"!=e.substr(r,3)){r++}r+=2;o=e.substr(i,r-i);t=r}if("\n"!=u.charAt(u.length-1))u+="\n";u+=this.cleanGetTabs();u+=o+">\n"}else if("!"==o[1]){u=this.placeTag(o+">",u)}else if("?"==o[1]){u+=o+">\n"}else if(f=o.match(/^<(script|style|pre)/i)){f[1]=f[1].toLowerCase();o=this.cleanTag(o);u=this.placeTag(o,u);s=String(e.substr(t+1)).toLowerCase().indexOf("</"+f[1]);if(s){a=e.substr(t+1,s);t+=s;u+=a}}else{o=this.cleanTag(o);u=this.placeTag(o,u)}}return this.cleanFinish(u)},cleanGetTabs:function(){var e="";for(var t=0;t<this.cleanlevel;t++){e+="	"}return e},cleanFinish:function(e){e=e.replace(/\n\s*\n/g,"\n");e=e.replace(/^[\s\n]*/,"");e=e.replace(/[\s\n]*$/,"");e=e.replace(/<script(.*?)>\n<\/script>/gi,"<script$1></script>");this.cleanlevel=0;return e},cleanTag:function(e){var t="";e=e.replace(/\n/g," ");e=e.replace(/\s{2,}/g," ");e=e.replace(/^\s+|\s+$/g," ");var n="";if(e.match(/\/$/)){n="/";e=e.replace(/\/+$/,"")}var r;while(r=/\s*([^= ]+)(?:=((['"']).*?\3|[^ ]+))?/.exec(e)){if(r[2])t+=r[1].toLowerCase()+"="+r[2];else if(r[1])t+=r[1].toLowerCase();t+=" ";e=e.substr(r[0].length)}return t.replace(/\s*$/,"")+n+">"},placeTag:function(e,t){var n=e.match(this.cleannewLevel);if(e.match(this.cleanlineBefore)||n){t=t.replace(/\s*$/,"");t+="\n"}if(n&&"/"==e.charAt(1))this.cleanlevel--;if("\n"==t.charAt(t.length-1))t+=this.cleanGetTabs();if(n&&"/"!=e.charAt(1))this.cleanlevel++;t+=e;if(e.match(this.cleanlineAfter)||e.match(this.cleannewLevel)){t=t.replace(/ *$/,"");t+="\n"}return t},formatEmpty:function(t){var n=e.trim(this.$editor.html());if(this.opts.linebreaks){if(n==""){t.preventDefault();this.$editor.html("");this.focus()}}else{n=n.replace(/<br\s?\/?>/i,"");var r=n.replace(/<p>\s?<\/p>/gi,"");if(n===""||r===""){t.preventDefault();var i=e(this.opts.emptyHtml).get(0);this.$editor.html(i);this.focus()}}this.sync()},formatBlocks:function(t){this.bufferSet();var n=this.getBlocks();this.selectionSave();e.each(n,e.proxy(function(n,r){if(r.tagName!=="LI"){var i=e(r).parent();if(t==="p"){if(r.tagName==="P"&&i.size()!=0&&i[0].tagName==="BLOCKQUOTE"||r.tagName==="BLOCKQUOTE"){this.formatQuote();return}else if(this.opts.linebreaks){if(r&&r.tagName.search(/H[1-6]/)==0){e(r).replaceWith(r.innerHTML+"<br>")}else return}else{this.formatBlock(t,r)}}else{this.formatBlock(t,r)}}},this));this.selectionRestore();this.sync()},formatBlock:function(t,n){if(n===false)n=this.getBlock();if(n===false){if(this.opts.linebreaks===true)this.execCommand("formatblock",t);return true}var r="";if(t!=="pre"){r=e(n).contents()}else{r=e(n).html();if(e.trim(r)===""){r='<span id="selection-marker-1"></span>'}}if(n.tagName==="PRE")t="p";if(this.opts.linebreaks===true&&t==="p"){e(n).replaceWith(e("<div>").append(r).html()+"<br>")}else{var i=this.getParent();var s=e("<"+t+">").append(r);e(n).replaceWith(s);if(i&&i.tagName=="TD"){e(s).wrapAll("<td>")}}},formatChangeTag:function(t,n,r){if(r!==false)this.selectionSave();var i=e("<"+n+"/>");e(t).replaceWith(function(){return i.append(e(this).contents())});if(r!==false)this.selectionRestore();return i},formatQuote:function(){this.bufferSet();if(this.opts.linebreaks===false){this.selectionSave();var t=this.getBlocks();var n=false;var r=t.length;if(t){var i="";var s="";var o=false;var u=true;e.each(t,function(e,t){if(t.tagName!=="P")u=false});e.each(t,e.proxy(function(a,f){if(f.tagName==="BLOCKQUOTE"){this.formatBlock("p",f,false)}else if(f.tagName==="P"){n=e(f).parent();if(n[0].tagName=="BLOCKQUOTE"){var l=e(n).children("p").size();if(l==1){e(n).replaceWith(f)}else if(l==r){o="blockquote";i+=this.outerHtml(f)}else{o="html";i+=this.outerHtml(f);if(a==0){e(f).addClass("redactor-replaced").empty();s=this.outerHtml(f)}else e(f).remove()}}else{if(u===false||t.length==1){this.formatBlock("blockquote",f,false)}else{o="paragraphs";i+=this.outerHtml(f)}}}else if(f.tagName!=="LI"){this.formatBlock("blockquote",f,false)}},this));if(o){if(o=="paragraphs"){e(t[0]).replaceWith("<blockquote>"+i+"</blockquote>");e(t).remove()}else if(o=="blockquote"){e(n).replaceWith(i)}else if(o=="html"){var a=this.$editor.html().replace(s,"</blockquote>"+i+"<blockquote>");this.$editor.html(a);this.$editor.find("blockquote").each(function(){if(e.trim(e(this).html())=="")e(this).remove()})}}}this.selectionRestore()}else{var f=this.getBlock();if(f.tagName==="BLOCKQUOTE"){this.selectionSave();var a=e.trim(e(f).html());var l=e.trim(this.getSelectionHtml());a=a.replace(/<span(.*?)id="selection-marker(.*?)<\/span>/gi,"");if(a==l){e(f).replaceWith(e(f).html()+"<br>")}else{this.inlineFormat("tmp");var c=this.$editor.find("tmp");c.empty();var h=this.$editor.html().replace("<tmp></tmp>",'</blockquote><span id="selection-marker-1">'+this.opts.invisibleSpace+"</span>"+l+"<blockquote>");this.$editor.html(h);c.remove();this.$editor.find("blockquote").each(function(){if(e.trim(e(this).html())=="")e(this).remove()})}this.selectionRestore();this.$editor.find("span#selection-marker-1").attr("id",false)}else{var p=this.selectionWrap("blockquote");var a=e(p).html();var d=["ul","ol","table","tr","tbody","thead","tfoot","dl"];e.each(d,function(e,t){a=a.replace(new RegExp("<"+t+"(.*?)>","gi"),"");a=a.replace(new RegExp("</"+t+">","gi"),"")});var v=this.opts.blockLevelElements;e.each(v,function(e,t){a=a.replace(new RegExp("<"+t+"(.*?)>","gi"),"");a=a.replace(new RegExp("</"+t+">","gi"),"<br>")});e(p).html(a);this.selectionElement(p);var m=e(p).next();if(m.size()!=0&&m[0].tagName==="BR"){m.remove()}}}this.sync()},blockRemoveAttr:function(t,n){var r=this.getBlocks();e(r).removeAttr(t);this.sync()},blockSetAttr:function(t,n){var r=this.getBlocks();e(r).attr(t,n);this.sync()},blockRemoveStyle:function(t){var n=this.getBlocks();e(n).css(t,"");this.removeEmptyAttr(n,"style");this.sync()},blockSetStyle:function(t,n){var r=this.getBlocks();e(r).css(t,n);this.sync()},blockRemoveClass:function(t){var n=this.getBlocks();e(n).removeClass(t);this.removeEmptyAttr(n,"class");this.sync()},blockSetClass:function(t){var n=this.getBlocks();e(n).addClass(t);this.sync()},inlineRemoveClass:function(t){this.selectionSave();this.inlineEachNodes(function(n){e(n).removeClass(t);this.removeEmptyAttr(n,"class")});this.selectionRestore();this.sync()},inlineSetClass:function(t){var n=this.getCurrent();if(!e(n).hasClass(t))this.inlineMethods("addClass",t)},inlineRemoveStyle:function(t){this.selectionSave();this.inlineEachNodes(function(n){e(n).css(t,"");this.removeEmptyAttr(n,"style")});this.selectionRestore();this.sync()},inlineSetStyle:function(e,t){this.inlineMethods("css",e,t)},inlineRemoveAttr:function(t){this.selectionSave();var n=this.getRange(),r=this.getElement(),i=this.getNodes();if(n.collapsed||n.startContainer===n.endContainer&&r){i=e(r)}e(i).removeAttr(t);this.inlineUnwrapSpan();this.selectionRestore();this.sync()},inlineSetAttr:function(e,t){this.inlineMethods("attr",e,t)},inlineMethods:function(t,n,r){this.bufferSet();this.selectionSave();var i=this.getRange();var s=this.getElement();if((i.collapsed||i.startContainer===i.endContainer)&&s&&!this.nodeTestBlocks(s)){e(s)[t](n,r)}else{this.document.execCommand("fontSize",false,4);var o=this.$editor.find("font");e.each(o,e.proxy(function(e,i){this.inlineSetMethods(t,i,n,r)},this))}this.selectionRestore();this.sync()},inlineSetMethods:function(t,n,r,i){var s=e(n).parent(),o;var u=this.getSelectionText();var a=e(s).text();var f=u==a;if(f&&s&&s[0].tagName==="INLINE"&&s[0].attributes.length!=0){o=s;e(n).replaceWith(e(n).html())}else{o=e("<inline>").append(e(n).contents());e(n).replaceWith(o)}e(o)[t](r,i);return o},inlineEachNodes:function(t){var n=this.getRange(),r=this.getElement(),i=this.getNodes(),s;if(n.collapsed||n.startContainer===n.endContainer&&r){i=e(r);s=true}e.each(i,e.proxy(function(n,r){if(!s&&r.tagName!=="INLINE"){var i=this.getSelectionText();var o=e(r).parent().text();var u=i==o;if(u&&r.parentNode.tagName==="INLINE"&&!e(r.parentNode).hasClass("redactor_editor")){r=r.parentNode}else return}t.call(this,r)},this))},inlineUnwrapSpan:function(){var t=this.$editor.find("inline");e.each(t,e.proxy(function(t,n){var r=e(n);if(r.attr("class")===undefined&&r.attr("style")===undefined){r.contents().unwrap()}},this))},inlineFormat:function(t){this.selectionSave();this.document.execCommand("fontSize",false,4);var n=this.$editor.find("font");var r;e.each(n,function(n,i){var s=e("<"+t+"/>").append(e(i).contents());e(i).replaceWith(s);r=s});this.selectionRestore();this.sync()},inlineRemoveFormat:function(t){this.selectionSave();var n=t.toUpperCase();var r=this.getNodes();var i=e(this.getParent()).parent();e.each(r,function(e,t){if(t.tagName===n)this.inlineRemoveFormatReplace(t)});if(i&&i[0].tagName===n)this.inlineRemoveFormatReplace(i);this.selectionRestore();this.sync()},inlineRemoveFormatReplace:function(t){e(t).replaceWith(e(t).contents())},insertHtml:function(t,n){var r=this.getCurrent();var i=r.parentNode;this.focusWithSaveScroll();this.bufferSet();var s=e("<div>").append(e.parseHTML(t));t=s.html();t=this.cleanRemoveEmptyTags(t);s=e("<div>").append(e.parseHTML(t));var o=this.getBlock();if(s.contents().length==1){var u=s.contents()[0].tagName;if(u!="P"&&u==o.tagName||u=="PRE"){t=s.text();s=e("<div>").append(t)}}if(!this.opts.linebreaks&&s.contents().length==1&&s.contents()[0].nodeType==3&&(this.getRangeSelectedNodes().length>2||!r||r.tagName=="BODY"&&!i||i.tagName=="HTML")){t="<p>"+t+"</p>"}t=this.setSpansVerifiedHtml(t);if(s.contents().length>1&&o||s.contents().is("p, :header, ul, ol, li, div, table, td, blockquote, pre, address, section, header, footer, aside, article")){if(this.browser("msie")){if(!this.isIe11()){this.document.selection.createRange().pasteHTML(t)}else{this.execPasteFrag(t)}}else{this.document.execCommand("inserthtml",false,t)}}else this.insertHtmlAdvanced(t,false);if(this.selectall){this.window.setTimeout(e.proxy(function(){if(!this.opts.linebreaks)this.selectionEnd(this.$editor.contents().last());else this.focusEnd()},this),1)}this.observeStart();this.setNonEditable();if(n!==false)this.sync()},insertHtmlAdvanced:function(e,t){e=this.setSpansVerifiedHtml(e);var n=this.getSelection();if(n.getRangeAt&&n.rangeCount){var r=n.getRangeAt(0);r.deleteContents();var i=this.document.createElement("div");i.innerHTML=e;var s=this.document.createDocumentFragment(),o,u;while(o=i.firstChild){u=s.appendChild(o)}r.insertNode(s);if(u){r=r.cloneRange();r.setStartAfter(u);r.collapse(true);n.removeAllRanges();n.addRange(r)}}if(t!==false){this.sync()}},insertBeforeCursor:function(t){t=this.setSpansVerifiedHtml(t);var n=e(t);var r=document.createElement("span");r.innerHTML="​";var i=this.getRange();i.insertNode(r);i.insertNode(n[0]);i.collapse(false);var s=this.getSelection();s.removeAllRanges();s.addRange(i);this.sync()},insertText:function(t){var n=e(e.parseHTML(t));if(n.length)t=n.text();this.focusWithSaveScroll();if(this.browser("msie")&&!this.isIe11())this.document.selection.createRange().pasteHTML(t);else this.document.execCommand("inserthtml",false,t);this.sync()},insertNode:function(t){t=t[0]||t;if(t.tagName=="SPAN"){var n="inline";var r=t.outerHTML;var i=new RegExp("<"+t.tagName,"i");var s=r.replace(i,"<"+n);i=new RegExp("</"+t.tagName,"i");s=s.replace(i,"</"+n);t=e(s)[0]}var o=this.getSelection();if(o.getRangeAt&&o.rangeCount){range=o.getRangeAt(0);range.deleteContents();range.insertNode(t);range.setEndAfter(t);range.setStartAfter(t);o.removeAllRanges();o.addRange(range)}},insertNodeToCaretPositionFromPoint:function(e,t){var n;var r=e.clientX,i=e.clientY;if(this.document.caretPositionFromPoint){var s=this.document.caretPositionFromPoint(r,i);n=this.getRange();n.setStart(s.offsetNode,s.offset);n.collapse(true);n.insertNode(t)}else if(this.document.caretRangeFromPoint){n=this.document.caretRangeFromPoint(r,i);n.insertNode(t)}else if(typeof document.body.createTextRange!="undefined"){n=this.document.body.createTextRange();n.moveToPoint(r,i);var o=n.duplicate();o.moveToPoint(r,i);n.setEndPoint("EndToEnd",o);n.select()}},insertAfterLastElement:function(t,n){if(typeof n!="undefined")t=n;if(this.isEndOfElement()){if(this.opts.linebreaks){var r=e("<div>").append(e.trim(this.$editor.html())).contents();if(this.outerHtml(r.last()[0])!=this.outerHtml(t)){return false}}else{if(this.$editor.contents().last()[0]!==t){return false}}this.insertingAfterLastElement(t)}},insertingAfterLastElement:function(t){this.bufferSet();if(this.opts.linebreaks===false){var n=e(this.opts.emptyHtml);e(t).after(n);this.selectionStart(n)}else{var n=e('<span id="selection-marker-1">'+this.opts.invisibleSpace+"</span>",this.document)[0];e(t).after(n);e(n).after(this.opts.invisibleSpace);this.selectionRestore();this.$editor.find("span#selection-marker-1").removeAttr("id")}},insertLineBreak:function(){this.selectionSave();this.$editor.find("#selection-marker-1").before("<br>"+(this.browser("webkit")?this.opts.invisibleSpace:""));this.selectionRestore()},insertDoubleLineBreak:function(){this.selectionSave();this.$editor.find("#selection-marker-1").before("<br><br>"+(this.browser("webkit")?this.opts.invisibleSpace:""));this.selectionRestore()},replaceLineBreak:function(t){var n=e("<br>"+this.opts.invisibleSpace);e(t).replaceWith(n);this.selectionStart(n)},pasteClean:function(t){t=this.callback("pasteBefore",false,t);if(this.browser("msie")){var n=e.trim(t);if(n.search(/^<a(.*?)>(.*?)<\/a>$/i)==0){t=t.replace(/^<a(.*?)>(.*?)<\/a>$/i,"$2")}}if(this.opts.pastePlainText){var n=this.document.createElement("div");t=t.replace(/<br>|<\/H[1-6]>|<\/p>|<\/div>/gi,"\n");n.innerHTML=t;t=n.textContent||n.innerText;t=e.trim(t);t=t.replace("\n","<br>");this.pasteInsert(t);return false}var r=false;if(this.currentOrParentIs("TD")){r=true;var i=this.opts.blockLevelElements;i.push("tr");i.push("table");e.each(i,function(e,n){t=t.replace(new RegExp("<"+n+"(.*?)>","gi"),"");t=t.replace(new RegExp("</"+n+">","gi"),"<br>")})}if(this.currentOrParentIs("PRE")){t=this.pastePre(t);this.pasteInsert(t);return true}t=t.replace(/<img(.*?)v:shapes=(.*?)>/gi,"");t=t.replace(/<p(.*?)class="MsoListParagraphCxSpFirst"([\w\W]*?)<\/p>/gi,"<ul><li$2</li>");t=t.replace(/<p(.*?)class="MsoListParagraphCxSpMiddle"([\w\W]*?)<\/p>/gi,"<li$2</li>");t=t.replace(/<p(.*?)class="MsoListParagraphCxSpLast"([\w\W]*?)<\/p>/gi,"<li$2</li></ul>");t=t.replace(/<p(.*?)class="MsoListParagraph"([\w\W]*?)<\/p>/gi,"<ul><li$2</li></ul>");t=t.replace(/·/g,"");t=t.replace(/<!--[\s\S]*?-->|<\?(?:php)?[\s\S]*?\?>/gi,"");t=t.replace(/(&nbsp;){2,}/gi,"&nbsp;");t=t.replace(/&nbsp;/gi," ");t=t.replace(/<b\sid="internal-source-marker(.*?)">([\w\W]*?)<\/b>/gi,"$2");t=t.replace(/<b(.*?)id="docs-internal-guid(.*?)">([\w\W]*?)<\/b>/gi,"$3");t=this.cleanStripTags(t);t=t.replace(/<td>\u200b*<\/td>/gi,"[td]");t=t.replace(/<td>&nbsp;<\/td>/gi,"[td]");t=t.replace(/<td><br><\/td>/gi,"[td]");t=t.replace(/<td(.*?)colspan="(.*?)"(.*?)>([\w\W]*?)<\/td>/gi,'[td colspan="$2"]$4[/td]');t=t.replace(/<td(.*?)rowspan="(.*?)"(.*?)>([\w\W]*?)<\/td>/gi,'[td rowspan="$2"]$4[/td]');t=t.replace(/<a(.*?)href="(.*?)"(.*?)>([\w\W]*?)<\/a>/gi,'[a href="$2"]$4[/a]');t=t.replace(/<iframe(.*?)>([\w\W]*?)<\/iframe>/gi,"[iframe$1]$2[/iframe]");t=t.replace(/<video(.*?)>([\w\W]*?)<\/video>/gi,"[video$1]$2[/video]");t=t.replace(/<audio(.*?)>([\w\W]*?)<\/audio>/gi,"[audio$1]$2[/audio]");t=t.replace(/<embed(.*?)>([\w\W]*?)<\/embed>/gi,"[embed$1]$2[/embed]");t=t.replace(/<object(.*?)>([\w\W]*?)<\/object>/gi,"[object$1]$2[/object]");t=t.replace(/<param(.*?)>/gi,"[param$1]");t=t.replace(/<img(.*?)>/gi,"[img$1]");t=t.replace(/ class="(.*?)"/gi,"");t=t.replace(/<(\w+)([\w\W]*?)>/gi,"<$1>");t=t.replace(/<[^\/>][^>]*>(\s*|\t*|\n*|&nbsp;|<br>)<\/[^>]+>/gi,"");t=t.replace(/<div>\s*?\t*?\n*?(<ul>|<ol>|<p>)/gi,"$1");t=t.replace(/\[td colspan="(.*?)"\]([\w\W]*?)\[\/td\]/gi,'<td colspan="$1">$2</td>');t=t.replace(/\[td rowspan="(.*?)"\]([\w\W]*?)\[\/td\]/gi,'<td rowspan="$1">$2</td>');t=t.replace(/\[td\]/gi,"<td>&nbsp;</td>");t=t.replace(/\[a href="(.*?)"\]([\w\W]*?)\[\/a\]/gi,'<a href="$1">$2</a>');t=t.replace(/\[iframe(.*?)\]([\w\W]*?)\[\/iframe\]/gi,"<iframe$1>$2</iframe>");t=t.replace(/\[video(.*?)\]([\w\W]*?)\[\/video\]/gi,"<video$1>$2</video>");t=t.replace(/\[audio(.*?)\]([\w\W]*?)\[\/audio\]/gi,"<audio$1>$2</audio>");t=t.replace(/\[embed(.*?)\]([\w\W]*?)\[\/embed\]/gi,"<embed$1>$2</embed>");t=t.replace(/\[object(.*?)\]([\w\W]*?)\[\/object\]/gi,"<object$1>$2</object>");t=t.replace(/\[param(.*?)\]/gi,"<param$1>");t=t.replace(/\[img(.*?)\]/gi,"<img$1>");if(this.opts.convertDivs){t=t.replace(/<div(.*?)>([\w\W]*?)<\/div>/gi,"<p>$2</p>");t=t.replace(/<\/div><p>/gi,"<p>");t=t.replace(/<\/p><\/div>/gi,"</p>");t=t.replace(/<p><\/p>/gi,"<br />")}else{t=t.replace(/<div><\/div>/gi,"<br />")}if(this.currentOrParentIs("LI")){t=t.replace(/<p>([\w\W]*?)<\/p>/gi,"$1<br>")}else if(r===false){t=this.cleanParagraphy(t)}t=t.replace(/<span(.*?)>([\w\W]*?)<\/span>/gi,"$2");t=t.replace(/<img>/gi,"");t=t.replace(/<[^\/>][^>][^img|param|source|td][^<]*>(\s*|\t*|\n*| |<br>)<\/[^>]+>/gi,"");t=t.replace(/\n{3,}/gi,"\n");t=t.replace(/<p><p>/gi,"<p>");t=t.replace(/<\/p><\/p>/gi,"</p>");t=t.replace(/<li>(\s*|\t*|\n*)<p>/gi,"<li>");t=t.replace(/<\/p>(\s*|\t*|\n*)<\/li>/gi,"</li>");if(this.opts.linebreaks===true){t=t.replace(/<p(.*?)>([\w\W]*?)<\/p>/gi,"$2<br>")}t=t.replace(/<[^\/>][^>][^img|param|source|td][^<]*>(\s*|\t*|\n*| |<br>)<\/[^>]+>/gi,"");t=t.replace(/<img src="webkit-fake-url\:\/\/(.*?)"(.*?)>/gi,"");t=t.replace(/<td(.*?)>(\s*|\t*|\n*)<p>([\w\W]*?)<\/p>(\s*|\t*|\n*)<\/td>/gi,"<td$1>$3</td>");if(this.opts.convertDivs){t=t.replace(/<div(.*?)>([\w\W]*?)<\/div>/gi,"$2");t=t.replace(/<div(.*?)>([\w\W]*?)<\/div>/gi,"$2")}this.pasteClipboardMozilla=false;if(this.browser("mozilla")){if(this.opts.clipboardUpload){var s=t.match(/<img src="data:image(.*?)"(.*?)>/gi);if(s!==null){this.pasteClipboardMozilla=s;for(k in s){var o=s[k].replace("<img",'<img data-mozilla-paste-image="'+k+'" ');t=t.replace(s[k],o)}}}while(/<br>$/gi.test(t)){t=t.replace(/<br>$/gi,"")}}t=t.replace(/<p>•([\w\W]*?)<\/p>/gi,"<li>$1</li>");while(/<font>([\w\W]*?)<\/font>/gi.test(t)){t=t.replace(/<font>([\w\W]*?)<\/font>/gi,"$1")}if(r===false){t=t.replace(/<td(.*?)>([\w\W]*?)<p(.*?)>([\w\W]*?)<\/td>/gi,"<td$1>$2$4</td>");t=t.replace(/<td(.*?)>([\w\W]*?)<\/p>([\w\W]*?)<\/td>/gi,"<td$1>$2$3</td>");t=t.replace(/<td(.*?)>([\w\W]*?)<p(.*?)>([\w\W]*?)<\/td>/gi,"<td$1>$2$4</td>");t=t.replace(/<td(.*?)>([\w\W]*?)<\/p>([\w\W]*?)<\/td>/gi,"<td$1>$2$3</td>")}t=t.replace(/\n/g," ");t=t.replace(/<p>\n?<li>/gi,"<li>");this.pasteInsert(t)},pastePre:function(e){e=e.replace(/<br>|<\/H[1-6]>|<\/p>|<\/div>/gi,"\n");var t=this.document.createElement("div");t.innerHTML=e;return this.cleanEncodeEntities(t.textContent||t.innerText)},pasteInsert:function(t){t=this.callback("pasteAfter",false,t);if(this.selectall){this.$editor.html(t);this.selectionRemove();this.focusEnd();this.sync()}else{this.insertHtml(t)}this.selectall=false;setTimeout(e.proxy(function(){this.rtePaste=false;if(this.browser("mozilla")){this.$editor.find("p:empty").remove()}if(this.pasteClipboardMozilla!==false){this.pasteClipboardUploadMozilla()}},this),100);if(this.opts.autoresize&&this.fullscreen!==true){this.document.documentElement.scrollTop=this.saveScroll}else{this.$editor.scrollTop(this.saveScroll)}},pasteClipboardAppendFields:function(t){if(this.opts.uploadFields!==false&&typeof this.opts.uploadFields==="object"){e.each(this.opts.uploadFields,e.proxy(function(n,r){if(r!=null&&r.toString().indexOf("#")===0)r=e(r).val();t[n]=r},this))}return t},pasteClipboardUploadMozilla:function(){var t=this.$editor.find("img[data-mozilla-paste-image]");e.each(t,e.proxy(function(t,n){var r=e(n);var i=n.src.split(",");var s={contentType:i[0].split(";")[0].split(":")[1],data:i[1]};s=this.pasteClipboardAppendFields(s);e.post(this.opts.clipboardUploadUrl,s,e.proxy(function(t){var n=typeof t==="string"?e.parseJSON(t):t;r.attr("src",n.filelink);r.removeAttr("data-mozilla-paste-image");this.sync();this.callback("imageUpload",r,n)},this))},this))},pasteClipboardUpload:function(t){var n=t.target.result;var r=n.split(",");var i={contentType:r[0].split(";")[0].split(":")[1],data:r[1]};if(this.opts.clipboardUpload){i=this.pasteClipboardAppendFields(i);e.post(this.opts.clipboardUploadUrl,i,e.proxy(function(t){var n=typeof t==="string"?e.parseJSON(t):t;var r='<img src="'+n.filelink+'" id="clipboard-image-marker" />';this.execCommand("inserthtml",r,false);var i=e(this.$editor.find("img#clipboard-image-marker"));if(i.length)i.removeAttr("id");else i=false;this.sync();if(i){this.callback("imageUpload",i,n)}},this))}else{this.insertHtml('<img src="'+n+'" />')}},bufferSet:function(e,t){if(e!==undefined||e===false)this.opts.buffer.push(e);else{if(t!==false){this.selectionSave()}this.opts.buffer.push(this.$editor.html());this.selectionRemoveMarkers("buffer")}},bufferUndo:function(){if(this.opts.buffer.length===0){this.focusWithSaveScroll();return}this.selectionSave();this.opts.rebuffer.push(this.$editor.html());this.selectionRestore(false,true);this.$editor.html(this.opts.buffer.pop());this.selectionRestore();setTimeout(e.proxy(this.observeStart,this),100)},bufferRedo:function(){if(this.opts.rebuffer.length===0){this.focusWithSaveScroll();return false}this.selectionSave();this.opts.buffer.push(this.$editor.html());this.selectionRestore(false,true);this.$editor.html(this.opts.rebuffer.pop());this.selectionRestore(true);setTimeout(e.proxy(this.observeStart,this),4)},observeStart:function(){this.observeImages();if(this.opts.observeLinks)this.observeLinks()},observeLinks:function(){this.$editor.find("a").on("click",e.proxy(this.linkObserver,this));this.$editor.on("click.redactor",e.proxy(function(e){this.linkObserverTooltipClose(e)},this));e(document).on("click.redactor",e.proxy(function(e){this.linkObserverTooltipClose(e)},this))},observeImages:function(){if(this.opts.observeImages===false)return false;this.$editor.find("img").each(e.proxy(function(t,n){if(this.browser("msie"))e(n).attr("unselectable","on");this.imageResize(n)},this))},linkObserver:function(t){var n=e(t.target);if(n.size()==0||n[0].tagName!=="A")return;var r=n.offset();if(this.opts.iframe){var i=this.$frame.offset();r.top=i.top+(r.top-e(this.document).scrollTop());r.left+=i.left}var s=e('<span class="redactor-link-tooltip"></span>');var o=n.attr("href");if(o.length>24)o=o.substring(0,24)+"...";var u=e('<a href="'+n.attr("href")+'" target="_blank">'+o+"</a>").on("click",e.proxy(function(e){this.linkObserverTooltipClose(false)},this));var a=e('<a href="#">'+this.opts.curLang.edit+"</a>").on("click",e.proxy(function(e){e.preventDefault();this.linkShow();this.linkObserverTooltipClose(false)},this));var f=e('<a href="#">'+this.opts.curLang.unlink+"</a>").on("click",e.proxy(function(e){e.preventDefault();this.execCommand("unlink");this.linkObserverTooltipClose(false)},this));s.append(u);s.append(" | ");s.append(a);s.append(" | ");s.append(f);s.css({top:r.top+20+"px",left:r.left+"px"});e(".redactor-link-tooltip").remove();e("body").append(s)},linkObserverTooltipClose:function(t){if(t!==false&&t.target.tagName=="A")return false;e(".redactor-link-tooltip").remove()},getSelection:function(){if(!this.opts.rangy)return this.document.getSelection();else{if(!this.opts.iframe)return rangy.getSelection();else return rangy.getSelection(this.$frame[0])}},getRange:function(){if(!this.opts.rangy){if(this.document.getSelection){var e=this.getSelection();if(e.getRangeAt&&e.rangeCount)return e.getRangeAt(0)}return this.document.createRange()}else{if(!this.opts.iframe)return rangy.createRange();else return rangy.createRange(this.iframeDoc())}},selectionElement:function(e){this.setCaret(e)},selectionStart:function(e){this.selectionSet(e[0]||e,0,null,0)},selectionEnd:function(e){this.selectionSet(e[0]||e,1,null,1)},selectionSet:function(t,n,r,i){if(r==null)r=t;if(i==null)i=n;var s=this.getSelection();if(!s)return;if(t.tagName=="P"&&t.innerHTML==""){t.innerHTML=this.opts.invisibleSpace}if(t.tagName=="BR"&&this.opts.linebreaks===false){var o=e(this.opts.emptyHtml)[0];e(t).replaceWith(o);t=o;r=t}var u=this.getRange();u.setStart(t,n);u.setEnd(r,i);try{s.removeAllRanges()}catch(a){}s.addRange(u)},selectionWrap:function(e){e=e.toLowerCase();var t=this.getBlock();if(t){var n=this.formatChangeTag(t,e);this.sync();return n}var r=this.getSelection();var i=r.getRangeAt(0);var n=document.createElement(e);n.appendChild(i.extractContents());i.insertNode(n);this.selectionElement(n);return n},selectionAll:function(){var e=this.getRange();e.selectNodeContents(this.$editor[0]);var t=this.getSelection();t.removeAllRanges();t.addRange(e)},selectionRemove:function(){this.getSelection().removeAllRanges()},getCaretOffset:function(t){var n=0;var r=this.getRange();var i=r.cloneRange();i.selectNodeContents(t);i.setEnd(r.endContainer,r.endOffset);n=e.trim(i.toString()).length;return n},getCaretOffsetRange:function(){return new n(this.getSelection().getRangeAt(0))},setCaret:function(e,t,n){if(typeof n==="undefined")n=t;e=e[0]||e;var r=this.getRange();r.selectNodeContents(e);var i=this.getTextNodesIn(e);var s=false;var o=0,u;if(i.length==1&&t){r.setStart(i[0],t);r.setEnd(i[0],n)}else{for(var a=0,f;f=i[a++];){u=o+f.length;if(!s&&t>=o&&(t<u||t==u&&a<i.length)){r.setStart(f,t-o);s=true}if(s&&n<=u){r.setEnd(f,n-o);break}o=u}}var l=this.getSelection();l.removeAllRanges();l.addRange(r)},getTextNodesIn:function(e){var t=[];if(e.nodeType==3)t.push(e);else{var n=e.childNodes;for(var r=0,i=n.length;r<i;++r){t.push.apply(t,this.getTextNodesIn(n[r]))}}return t},getCurrent:function(){var e=false;var t=this.getSelection();if(t&&t.rangeCount>0)e=t.getRangeAt(0).startContainer;return this.isParentRedactor(e)},getParent:function(t){t=t||this.getCurrent();if(t)return this.isParentRedactor(e(t).parent()[0]);else return false},getBlock:function(t){if(typeof t==="undefined")t=this.getCurrent();while(t){if(this.nodeTestBlocks(t)){if(e(t).hasClass("redactor_editor"))return false;return t}t=t.parentNode}return false},getBlocks:function(t){var n=[];if(typeof t=="undefined"){var r=this.getRange();if(r&&r.collapsed===true)return[this.getBlock()];var t=this.getNodes(r)}e.each(t,e.proxy(function(t,r){if(this.opts.iframe===false&&e(r).parents("div.redactor_editor").size()==0)return false;if(this.nodeTestBlocks(r))n.push(r)},this));if(n.length===0)n=[this.getBlock()];return n},nodeTestBlocks:function(e){return e.nodeType==1&&this.rTestBlock.test(e.nodeName)},tagTestBlock:function(e){return this.rTestBlock.test(e)},getNodes:function(t,n){if(typeof t=="undefined"||t==false)var t=this.getRange();if(t&&t.collapsed===true){if(typeof n==="undefined"&&this.tagTestBlock(n)){var r=this.getBlock();if(r.tagName==n)return[r];else return[]}else{return[this.getCurrent()]}}var i=[],s=[];var o=this.document.getSelection();if(!o.isCollapsed)i=this.getRangeSelectedNodes(o.getRangeAt(0));e.each(i,e.proxy(function(t,r){if(this.opts.iframe===false&&e(r).parents("div.redactor_editor").size()==0)return false;if(typeof n==="undefined"){if(e.trim(r.textContent)!=""){s.push(r)}}else if(r.tagName==n){s.push(r)}},this));if(s.length==0){if(typeof n==="undefined"&&this.tagTestBlock(n)){var r=this.getBlock();if(r.tagName==n)return s.push(r);else return[]}else{s.push(this.getCurrent())}}var u=s[s.length-1];if(this.nodeTestBlocks(u)){s=s.slice(0,-1)}return s},getElement:function(t){if(!t)t=this.getCurrent();while(t){if(t.nodeType==1){if(e(t).hasClass("redactor_editor"))return false;return t}t=t.parentNode}return false},getRangeSelectedNodes:function(e){e=e||this.getRange();var t=e.startContainer;var n=e.endContainer;if(t==n)return[t];var r=[];while(t&&t!=n){r.push(t=this.nextNode(t))}t=e.startContainer;while(t&&t!=e.commonAncestorContainer){r.unshift(t);t=t.parentNode}return r},nextNode:function(e){if(e.hasChildNodes())return e.firstChild;else{while(e&&!e.nextSibling){e=e.parentNode}if(!e)return null;return e.nextSibling}},getSelectionText:function(){return this.getSelection().toString()},getSelectionHtml:function(){var e="";var t=this.getSelection();if(t.rangeCount){var n=this.document.createElement("div");var r=t.rangeCount;for(var i=0;i<r;++i){n.appendChild(t.getRangeAt(i).cloneContents())}e=n.innerHTML}return this.syncClean(e)},selectionSave:function(){if(!this.isFocused())this.focusWithSaveScroll();if(!this.opts.rangy){this.selectionCreateMarker(this.getRange())}else{this.savedSel=rangy.saveSelection()}},selectionCreateMarker:function(t,n){if(!t)return;var r=e('<span id="selection-marker-1" class="redactor-selection-marker">'+this.opts.invisibleSpace+"</span>",this.document)[0];var i=e('<span id="selection-marker-2" class="redactor-selection-marker">'+this.opts.invisibleSpace+"</span>",this.document)[0];if(t.collapsed===true){this.selectionSetMarker(t,r,true)}else{this.selectionSetMarker(t,r,true);this.selectionSetMarker(t,i,false)}this.savedSel=this.$editor.html();this.selectionRestore(false,false)},selectionSetMarker:function(e,t,n){var r=e.cloneRange();r.collapse(n);r.insertNode(t);r.detach()},selectionRestore:function(e,t){if(!this.opts.rangy){if(e===true&&this.savedSel){this.$editor.html(this.savedSel)}var n=this.$editor.find("span#selection-marker-1");var r=this.$editor.find("span#selection-marker-2");if(this.browser("mozilla")){this.$editor.focus()}else if(!this.isFocused()){this.focusWithSaveScroll()}if(n.length!=0&&r.length!=0){this.selectionSet(n[0],0,r[0],0)}else if(n.length!=0){this.selectionSet(n[0],0,null,0)}if(t!==false){this.selectionRemoveMarkers();this.savedSel=false}}else{rangy.restoreSelection(this.savedSel)}},selectionRemoveMarkers:function(t){if(!this.opts.rangy){e.each(this.$editor.find("span.redactor-selection-marker"),function(){var t=e.trim(e(this).html().replace(/[^\u0000-\u1C7F]/g,""));if(t==""){e(this).remove()}else{e(this).removeAttr("class").removeAttr("id")}})}else{rangy.removeMarkers(this.savedSel)}},tableShow:function(){this.selectionSave();this.modalInit(this.opts.curLang.table,this.opts.modal_table,300,e.proxy(function(){e("#redactor_insert_table_btn").click(e.proxy(this.tableInsert,this));setTimeout(function(){e("#redactor_table_rows").focus()},200)},this))},tableInsert:function(){this.bufferSet();var t=e("#redactor_table_rows").val(),n=e("#redactor_table_columns").val(),r=e("<div></div>"),i=Math.floor(Math.random()*99999),s=e('<table id="table'+i+'"><tbody></tbody></table>'),o,u,a,f;for(o=0;o<t;o++){u=e("<tr></tr>");for(a=0;a<n;a++){f=e("<td>"+this.opts.invisibleSpace+"</td>");if(o===0&&a===0){f.append('<span id="selection-marker-1">'+this.opts.invisibleSpace+"</span>")}e(u).append(f)}s.append(u)}r.append(s);var l=r.html();this.modalClose();this.selectionRestore();var c=this.getBlock()||this.getCurrent();if(c&&c.tagName!="BODY"){if(c.tagName=="LI"){var c=e(c).closest("ul, ol")}e(c).after(l)}else{this.insertHtmlAdvanced(l,false)}this.selectionRestore();var h=this.$editor.find("#table"+i);this.buttonActiveObserver();h.find("span#selection-marker-1, inline#selection-marker-1").remove();h.removeAttr("id");this.sync()},tableDeleteTable:function(){var t=e(this.getParent()).closest("table");if(!this.isParentRedactor(t))return false;if(t.size()==0)return false;this.bufferSet();t.remove();this.sync()},tableDeleteRow:function(){var t=this.getParent();var n=e(t).closest("table");if(!this.isParentRedactor(n))return false;if(n.size()==0)return false;this.bufferSet();var r=e(t).closest("tr");var i=r.prev().length?r.prev():r.next();if(i.length){var s=i.children("td").first();if(s.length){s.prepend('<span id="selection-marker-1">'+this.opts.invisibleSpace+"</span>")}}r.remove();this.selectionRestore();this.sync()},tableDeleteColumn:function(){var t=this.getParent();var n=e(t).closest("table");if(!this.isParentRedactor(n))return false;if(n.size()==0)return false;this.bufferSet();var r=e(t).closest("td");if(!r.is("td")){r=r.closest("td")}var i=r.get(0).cellIndex;n.find("tr").each(e.proxy(function(t,n){var r=i-1<0?i+1:i-1;if(t===0){e(n).find("td").eq(r).prepend('<span id="selection-marker-1">'+this.opts.invisibleSpace+"</span>")}e(n).find("td").eq(i).remove()},this));this.selectionRestore();this.sync()},tableAddHead:function(){var t=e(this.getParent()).closest("table");if(!this.isParentRedactor(t))return false;if(t.size()==0)return false;this.bufferSet();if(t.find("thead").size()!==0)this.tableDeleteHead();else{var n=t.find("tr").first().clone();n.find("td").html(this.opts.invisibleSpace);$thead=e("<thead></thead>");$thead.append(n);t.prepend($thead);this.sync()}},tableDeleteHead:function(){var t=e(this.getParent()).closest("table");if(!this.isParentRedactor(t))return false;var n=t.find("thead");if(n.size()==0)return false;this.bufferSet();n.remove();this.sync()},tableAddRowAbove:function(){this.tableAddRow("before")},tableAddRowBelow:function(){this.tableAddRow("after")},tableAddColumnLeft:function(){this.tableAddColumn("before")},tableAddColumnRight:function(){this.tableAddColumn("after")},tableAddRow:function(t){var n=e(this.getParent()).closest("table");if(!this.isParentRedactor(n))return false;if(n.size()==0)return false;this.bufferSet();var r=e(this.getParent()).closest("tr");var i=r.clone();i.find("td").html(this.opts.invisibleSpace);if(t==="after")r.after(i);else r.before(i);this.sync()},tableAddColumn:function(t){var n=this.getParent();var r=e(n).closest("table");if(!this.isParentRedactor(r))return false;if(r.size()==0)return false;this.bufferSet();var i=0;var s=this.getCurrent();var o=e(s).closest("tr");var u=e(s).closest("td");o.find("td").each(e.proxy(function(t,n){if(e(n)[0]===u[0])i=t},this));r.find("tr").each(e.proxy(function(n,r){var s=e(r).find("td").eq(i);var o=s.clone();o.html(this.opts.invisibleSpace);t==="after"?s.after(o):s.before(o)},this));this.sync()},videoShow:function(){this.selectionSave();this.modalInit(this.opts.curLang.video,this.opts.modal_video,600,e.proxy(function(){e("#redactor_insert_video_btn").click(e.proxy(this.videoInsert,this));setTimeout(function(){e("#redactor_insert_video_area").focus()},200)},this))},videoInsert:function(){var t=e("#redactor_insert_video_area").val();t=this.cleanStripTags(t);this.selectionRestore();var n=this.getBlock()||this.getCurrent();if(n)e(n).after(t);else this.insertHtmlAdvanced(t,false);this.sync();this.modalClose()},linkShow:function(){this.selectionSave();var t=e.proxy(function(){this.insert_link_node=false;var t=this.getSelection();var n="",r="",i="";var s=this.getParent();var o=e(s).parent().get(0);if(o&&o.tagName==="A"){s=o}if(s&&s.tagName==="A"){n=s.href;r=e(s).text();i=s.target;this.insert_link_node=s}else r=t.toString();e(".redactor_link_text").val(r);var u=self.location.href.replace(/\/$/i,"");var a=n.replace(u,"");if(this.opts.linkProtocol===false){var f=new RegExp("^(http|ftp|https)://"+self.location.host,"i");a=a.replace(f,"")}var l=e("#redactor_tabs").find("a");if(this.opts.linkEmail===false)l.eq(1).remove();if(this.opts.linkAnchor===false)l.eq(2).remove();if(this.opts.linkEmail===false&&this.opts.linkAnchor===false){e("#redactor_tabs").remove();e("#redactor_link_url").val(a)}else{if(n.search("mailto:")===0){this.modalSetTab.call(this,2);e("#redactor_tab_selected").val(2);e("#redactor_link_mailto").val(n.replace("mailto:",""))}else if(a.search(/^#/gi)===0){this.modalSetTab.call(this,3);e("#redactor_tab_selected").val(3);e("#redactor_link_anchor").val(a.replace(/^#/gi,""))}else{e("#redactor_link_url").val(a)}}if(i==="_blank")e("#redactor_link_blank").prop("checked",true);this.linkInsertPressed=false;e("#redactor_insert_link_btn").click(e.proxy(this.linkProcess,this));setTimeout(function(){e("#redactor_link_url").focus()},200)},this);this.modalInit(this.opts.curLang.link,this.opts.modal_link,460,t)},linkProcess:function(){if(this.linkInsertPressed){return}this.linkInsertPressed=true;var t=e("#redactor_tab_selected").val();var n="",r="",i="",s="";if(t==="1"){n=e("#redactor_link_url").val();r=e("#redactor_link_url_text").val();if(e("#redactor_link_blank").prop("checked")){i=' target="_blank"';s="_blank"}var o="((xn--)?[a-z0-9]+(-[a-z0-9]+)*.)+[a-z]{2,}";var u=new RegExp("^(http|ftp|https)://"+o,"i");var a=new RegExp("^"+o,"i");if(n.search(u)==-1&&n.search(a)==0&&this.opts.linkProtocol){n=this.opts.linkProtocol+n}}else if(t==="2"){n="mailto:"+e("#redactor_link_mailto").val();r=e("#redactor_link_mailto_text").val()}else if(t==="3"){n="#"+e("#redactor_link_anchor").val();r=e("#redactor_link_anchor_text").val()}r=r.replace(/<|>/g,"");this.linkInsert('<a href="'+n+'"'+i+">"+r+"</a>",e.trim(r),n,s)},linkInsert:function(t,n,r,i){this.selectionRestore();if(n!==""){if(this.insert_link_node){this.bufferSet();e(this.insert_link_node).text(n).attr("href",r);if(i!=="")e(this.insert_link_node).attr("target",i);else e(this.insert_link_node).removeAttr("target");this.sync()}else{var s=e(t).addClass("redactor-added-link");this.exec("inserthtml",this.outerHtml(s),false);this.$editor.find("a.redactor-added-link").removeAttr("style").removeClass("redactor-added-link").each(function(){if(this.className=="")e(this).removeAttr("class")});this.sync()}}setTimeout(e.proxy(function(){if(this.opts.observeLinks)this.observeLinks()},this),5);this.modalClose()},fileShow:function(){this.selectionSave();var t=e.proxy(function(){var t=this.getSelection();var n="";if(this.oldIE())n=t.text;else n=t.toString();e("#redactor_filename").val(n);if(!this.isMobile()&&!this.isIPad()){this.draguploadInit("#redactor_file",{url:this.opts.fileUpload,uploadFields:this.opts.uploadFields,success:e.proxy(this.fileCallback,this),error:e.proxy(function(e,t){this.callback("fileUploadError",t)},this),uploadParam:this.opts.fileUploadParam})}this.uploadInit("redactor_file",{auto:true,url:this.opts.fileUpload,success:e.proxy(this.fileCallback,this),error:e.proxy(function(e,t){this.callback("fileUploadError",t)},this)})},this);this.modalInit(this.opts.curLang.file,this.opts.modal_file,500,t)},fileCallback:function(t){this.selectionRestore();if(t!==false){var n=e("#redactor_filename").val();if(n==="")n=t.filename;var r='<a href="'+t.filelink+'" id="filelink-marker">'+n+"</a>";if(this.browser("webkit")&&!!this.window.chrome){r=r+"&nbsp;"}this.execCommand("inserthtml",r,false);var i=e(this.$editor.find("a#filelink-marker"));if(i.size()!=0)i.removeAttr("id");else i=false;this.sync();this.callback("fileUpload",i,t)}this.modalClose()},imageShow:function(){this.selectionSave();var t=e.proxy(function(){if(this.opts.imageGetJson){e.getJSON(this.opts.imageGetJson,e.proxy(function(t){var n={},r=0;e.each(t,e.proxy(function(e,t){if(typeof t.folder!=="undefined"){r++;n[t.folder]=r}},this));var i=false;e.each(t,e.proxy(function(t,r){var s="";if(typeof r.title!=="undefined")s=r.title;var o=0;if(!e.isEmptyObject(n)&&typeof r.folder!=="undefined"){o=n[r.folder];if(i===false)i=".redactorfolder"+o}var u=e('<img src="'+r.thumb+'" class="redactorfolder redactorfolder'+o+'" rel="'+r.image+'" title="'+s+'" />');e("#redactor_image_box").append(u);e(u).click(e.proxy(this.imageThumbClick,this))},this));if(!e.isEmptyObject(n)){e(".redactorfolder").hide();e(i).show();var s=function(t){e(".redactorfolder").hide();e(".redactorfolder"+e(t.target).val()).show()};var o=e('<select id="redactor_image_box_select">');e.each(n,function(t,n){o.append(e('<option value="'+n+'">'+t+"</option>"))});e("#redactor_image_box").before(o);o.change(s)}},this))}else{e("#redactor-modal-tab-2").remove()}if(this.opts.imageUpload||this.opts.s3){if(!this.isMobile()&&!this.isIPad()&&this.opts.s3===false){if(e("#redactor_file").length){this.draguploadInit("#redactor_file",{url:this.opts.imageUpload,uploadFields:this.opts.uploadFields,success:e.proxy(this.imageCallback,this),error:e.proxy(function(e,t){this.callback("imageUploadError",t)},this),uploadParam:this.opts.imageUploadParam})}}if(this.opts.s3===false){this.uploadInit("redactor_file",{auto:true,url:this.opts.imageUpload,success:e.proxy(this.imageCallback,this),error:e.proxy(function(e,t){this.callback("imageUploadError",t)},this)})}else{e("#redactor_file").on("change.redactor",e.proxy(this.s3handleFileSelect,this))}}else{e(".redactor_tab").hide();if(!this.opts.imageGetJson){e("#redactor_tabs").remove();e("#redactor_tab3").show()}else{e("#redactor-modal-tab-1").remove();e("#redactor-modal-tab-2").addClass("redactor_tabs_act");e("#redactor_tab2").show()}}if(!this.opts.imageTabLink&&(this.opts.imageUpload||this.opts.imageGetJson)){e("#redactor-tab-control-3").hide()}e("#redactor_upload_btn").click(e.proxy(this.imageCallbackLink,this));if(!this.opts.imageUpload&&!this.opts.imageGetJson){setTimeout(function(){e("#redactor_file_link").focus()},200)}},this);this.modalInit(this.opts.curLang.image,this.opts.modal_image,610,t)},imageEdit:function(t){var n=t;var r=n.parent().parent();var i=e.proxy(function(){e("#redactor_file_alt").val(n.attr("alt"));e("#redactor_image_edit_src").attr("href",n.attr("src"));if(n.css("display")=="block"&&n.css("float")=="none"){e("#redactor_form_image_align").val("center")}else{e("#redactor_form_image_align").val(n.css("float"))}if(e(r).get(0).tagName==="A"){e("#redactor_file_link").val(e(r).attr("href"));if(e(r).attr("target")=="_blank"){e("#redactor_link_blank").prop("checked",true)}}e("#redactor_image_delete_btn").click(e.proxy(function(){this.imageRemove(n)},this));e("#redactorSaveBtn").click(e.proxy(function(){this.imageSave(n)},this))},this);this.modalInit(this.opts.curLang.edit,this.opts.modal_image_edit,380,i)},imageRemove:function(t){var n=e(t).parent().parent();var r=e(t).parent();var i=false;if(n.length&&n[0].tagName==="A"){i=true;e(n).remove()}else if(r.length&&r[0].tagName==="A"){i=true;e(r).remove()}else{e(t).remove()}if(r.length&&r[0].tagName==="P"){this.focusWithSaveScroll();if(i===false)this.selectionStart(r)}this.callback("imageDelete",t);this.modalClose();this.sync()},imageSave:function(t){var n=e(t);var r=n.parent();n.attr("alt",e("#redactor_file_alt").val());var i=e("#redactor_form_image_align").val();var s="";this.imageResizeHide(false);if(i==="left"){s="0 "+this.opts.imageFloatMargin+" "+this.opts.imageFloatMargin+" 0";n.css({"float":"left",margin:s})}else if(i==="right"){s="0 0 "+this.opts.imageFloatMargin+" "+this.opts.imageFloatMargin+"";n.css({"float":"right",margin:s})}else if(i==="center"){n.css({"float":"",display:"block",margin:"auto"})}else{n.css({"float":"",display:"",margin:""})}var o=e.trim(e("#redactor_file_link").val());if(o!==""){var u=false;if(e("#redactor_link_blank").prop("checked")){u=true}if(r.get(0).tagName!=="A"){var a=e('<a href="'+o+'">'+this.outerHtml(t)+"</a>");if(u){a.attr("target","_blank")}n.replaceWith(a)}else{r.attr("href",o);if(u){r.attr("target","_blank")}else{r.removeAttr("target")}}}else{if(r.get(0).tagName==="A"){r.replaceWith(this.outerHtml(t))}}this.modalClose();this.observeImages();this.sync()},imageResizeHide:function(t){if(t!==false&&e(t.target).parent().size()!=0&&e(t.target).parent()[0].id==="redactor-image-box"){return false}var n=this.$editor.find("#redactor-image-box");if(n.size()==0){return false}this.$editor.find("#redactor-image-editter, #redactor-image-resizer").remove();n.find("img").css({marginTop:n[0].style.marginTop,marginBottom:n[0].style.marginBottom,marginLeft:n[0].style.marginLeft,marginRight:n[0].style.marginRight});n.css("margin","");n.find("img").css("opacity","");n.replaceWith(function(){return e(this).contents()});e(document).off("click.redactor-image-resize-hide");this.$editor.off("click.redactor-image-resize-hide");this.$editor.off("keydown.redactor-image-delete");this.sync()},imageResize:function(t){var n=e(t);n.on("mousedown",e.proxy(function(){this.imageResizeHide(false)},this));n.on("dragstart",e.proxy(function(){this.$editor.on("drop.redactor-image-inside-drop",e.proxy(function(){setTimeout(e.proxy(function(){this.observeImages();this.$editor.off("drop.redactor-image-inside-drop");this.sync()},this),1)},this))},this));n.on("click",e.proxy(function(t){if(this.$editor.find("#redactor-image-box").size()!=0){return false}var r=false,i,s,o=n.width()/n.height(),u=20,a=10;var f=this.imageResizeControls(n);var l=false;f.on("mousedown",function(e){l=true;e.preventDefault();o=n.width()/n.height();i=Math.round(e.pageX-n.eq(0).offset().left);s=Math.round(e.pageY-n.eq(0).offset().top)});e(this.document.body).on("mousemove",e.proxy(function(e){if(l){var t=Math.round(e.pageX-n.eq(0).offset().left)-i;var r=Math.round(e.pageY-n.eq(0).offset().top)-s;var a=n.height();var f=parseInt(a,10)+r;var c=Math.round(f*o);if(c>u){n.width(c);n.attr("width",c);n.attr("height",f);if(c<100){this.imageEditter.css({marginTop:"-7px",marginLeft:"-13px",fontSize:"9px",padding:"3px 5px"})}else{this.imageEditter.css({marginTop:"-11px",marginLeft:"-18px",fontSize:"11px",padding:"7px 10px"})}}i=Math.round(e.pageX-n.eq(0).offset().left);s=Math.round(e.pageY-n.eq(0).offset().top);this.sync()}},this)).on("mouseup",function(){l=false});this.$editor.on("keydown.redactor-image-delete",e.proxy(function(e){var t=e.which;if(this.keyCode.BACKSPACE==t||this.keyCode.DELETE==t){this.bufferSet(false,false);this.imageResizeHide(false);this.imageRemove(n)}},this));e(document).on("click.redactor-image-resize-hide",e.proxy(this.imageResizeHide,this));this.$editor.on("click.redactor-image-resize-hide",e.proxy(this.imageResizeHide,this))},this))},imageResizeControls:function(t){var n=e('<span id="redactor-image-box" data-redactor="verified">');n.css({position:"relative",display:"inline-block",lineHeight:0,outline:"1px dashed rgba(0, 0, 0, .6)","float":t.css("float")});n.attr("contenteditable",false);if(t[0].style.margin!="auto"){n.css({marginTop:t[0].style.marginTop,marginBottom:t[0].style.marginBottom,marginLeft:t[0].style.marginLeft,marginRight:t[0].style.marginRight});t.css("margin","")}else{n.css({display:"block",margin:"auto"})}t.css("opacity",.5).after(n);this.imageEditter=e('<span id="redactor-image-editter" data-redactor="verified">'+this.opts.curLang.edit+"</span>");this.imageEditter.css({position:"absolute",zIndex:5,top:"50%",left:"50%",marginTop:"-11px",marginLeft:"-18px",lineHeight:1,backgroundColor:"#000",color:"#fff",fontSize:"11px",padding:"7px 10px",cursor:"pointer"});this.imageEditter.attr("contenteditable",false);this.imageEditter.on("click",e.proxy(function(){this.imageEdit(t)},this));n.append(this.imageEditter);var r=e('<span id="redactor-image-resizer" data-redactor="verified"></span>');r.css({position:"absolute",zIndex:2,lineHeight:1,cursor:"nw-resize",bottom:"-4px",right:"-5px",border:"1px solid #fff",backgroundColor:"#000",width:"8px",height:"8px"});r.attr("contenteditable",false);n.append(r);n.append(t);return r},imageThumbClick:function(t){var n='<img id="image-marker" src="'+e(t.target).attr("rel")+'" alt="'+e(t.target).attr("title")+'" />';var r=this.getParent();if(this.opts.paragraphy&&e(r).closest("li").size()==0)n="<p>"+n+"</p>";this.imageInsert(n,true)},imageCallbackLink:function(){var t=e("#redactor_file_link").val();if(t!==""){var n='<img id="image-marker" src="'+t+'" />';if(this.opts.linebreaks===false)n="<p>"+n+"</p>";this.imageInsert(n,true)}else this.modalClose()},imageCallback:function(e){this.imageInsert(e)},imageInsert:function(t,n){this.selectionRestore();if(t!==false){var r="";if(n!==true){r='<img id="image-marker" src="'+t.filelink+'" />';var i=this.getParent();if(this.opts.paragraphy&&e(i).closest("li").size()==0){r="<p>"+r+"</p>"}}else{r=t}this.execCommand("inserthtml",r,false);var s=e(this.$editor.find("img#image-marker"));if(s.length)s.removeAttr("id");else s=false;this.sync();n!==true&&this.callback("imageUpload",s,t)}this.modalClose();this.observeImages()},modalTemplatesInit:function(){e.extend(this.opts,{modal_file:String()+"<section>"+'<div id="redactor-progress" class="redactor-progress-inline" style="display: none;"><span></span></div>'+'<form id="redactorUploadFileForm" method="post" action="" enctype="multipart/form-data">'+"<label>"+this.opts.curLang.filename+"</label>"+'<input type="text" id="redactor_filename" class="redactor_input" />'+'<div style="margin-top: 7px;">'+'<input type="file" id="redactor_file" name="'+this.opts.fileUploadParam+'" />'+"</div>"+"</form>"+"</section>",modal_image_edit:String()+"<section>"+"<label>"+this.opts.curLang.title+"</label>"+'<input id="redactor_file_alt" class="redactor_input" />'+"<label>"+this.opts.curLang.link+"</label>"+'<input id="redactor_file_link" class="redactor_input" />'+'<label><input type="checkbox" id="redactor_link_blank"> '+this.opts.curLang.link_new_tab+"</label>"+"<label>"+this.opts.curLang.image_position+"</label>"+'<select id="redactor_form_image_align">'+'<option value="none">'+this.opts.curLang.none+"</option>"+'<option value="left">'+this.opts.curLang.left+"</option>"+'<option value="center">'+this.opts.curLang.center+"</option>"+'<option value="right">'+this.opts.curLang.right+"</option>"+"</select>"+"</section>"+"<footer>"+'<div style="width: 33%;"><button class="redactor_modal_delete_btn" id="redactor_image_delete_btn">'+this.opts.curLang._delete+"</button></div>"+'<div style="width: 33%;"><button class="redactor_btn_modal_close">'+this.opts.curLang.cancel+"</button></div>"+'<div style="width: 34%;"><button class="redactor_modal_action_btn" id="redactorSaveBtn">'+this.opts.curLang.save+"</button></div>"+"</footer>",modal_image:String()+"<section>"+'<div id="redactor_tabs">'+'<a href="#" id="redactor-tab-control-1" class="redactor_tabs_act">'+this.opts.curLang.upload+"</a>"+'<a href="#" id="redactor-tab-control-2">'+this.opts.curLang.choose+"</a>"+'<a href="#" id="redactor-tab-control-3">'+this.opts.curLang.link+"</a>"+"</div>"+'<div id="redactor-progress" class="redactor-progress-inline" style="display: none;"><span></span></div>'+'<form id="redactorInsertImageForm" method="post" action="" enctype="multipart/form-data">'+'<div id="redactor_tab1" class="redactor_tab">'+'<input type="file" id="redactor_file" name="'+this.opts.imageUploadParam+'" />'+"</div>"+'<div id="redactor_tab2" class="redactor_tab" style="display: none;">'+'<div id="redactor_image_box"></div>'+"</div>"+"</form>"+'<div id="redactor_tab3" class="redactor_tab" style="display: none;">'+"<label>"+this.opts.curLang.image_web_link+"</label>"+'<input type="text" name="redactor_file_link" id="redactor_file_link" class="redactor_input"  /><br><br>'+"</div>"+"</section>"+"<footer>"+'<div style="width: 50%;"><button class="redactor_btn_modal_close">'+this.opts.curLang.cancel+"</button></div>"+'<div style="width: 50%;"><button class="redactor_modal_action_btn" id="redactor_upload_btn">'+this.opts.curLang.insert+"</button></div>"+"</footer>",modal_link:String()+"<section>"+'<form id="redactorInsertLinkForm" method="post" action="">'+'<div id="redactor_tabs">'+'<a href="#" class="redactor_tabs_act">URL</a>'+'<a href="#">Email</a>'+'<a href="#">'+this.opts.curLang.anchor+"</a>"+"</div>"+'<input type="hidden" id="redactor_tab_selected" value="1" />'+'<div class="redactor_tab" id="redactor_tab1">'+"<label>URL</label>"+'<input type="text" id="redactor_link_url" class="redactor_input"  />'+"<label>"+this.opts.curLang.text+"</label>"+'<input type="text" class="redactor_input redactor_link_text" id="redactor_link_url_text" />'+'<label><input type="checkbox" id="redactor_link_blank"> '+this.opts.curLang.link_new_tab+"</label>"+"</div>"+'<div class="redactor_tab" id="redactor_tab2" style="display: none;">'+"<label>Email</label>"+'<input type="text" id="redactor_link_mailto" class="redactor_input" />'+"<label>"+this.opts.curLang.text+"</label>"+'<input type="text" class="redactor_input redactor_link_text" id="redactor_link_mailto_text" />'+"</div>"+'<div class="redactor_tab" id="redactor_tab3" style="display: none;">'+"<label>"+this.opts.curLang.anchor+"</label>"+'<input type="text" class="redactor_input" id="redactor_link_anchor"  />'+"<label>"+this.opts.curLang.text+"</label>"+'<input type="text" class="redactor_input redactor_link_text" id="redactor_link_anchor_text" />'+"</div>"+"</form>"+"</section>"+"<footer>"+'<div style="width: 50%;"><button class="redactor_btn_modal_close">'+this.opts.curLang.cancel+"</button></div>"+'<div style="width: 50%;"><button class="redactor_modal_action_btn" id="redactor_insert_link_btn">'+this.opts.curLang.insert+"</button></div>"+"</footer>",modal_table:String()+"<section>"+"<label>"+this.opts.curLang.rows+"</label>"+'<input type="text" size="5" value="2" id="redactor_table_rows" />'+"<label>"+this.opts.curLang.columns+"</label>"+'<input type="text" size="5" value="3" id="redactor_table_columns" />'+"</section>"+"<footer>"+'<div style="width: 50%;"><button class="redactor_btn_modal_close">'+this.opts.curLang.cancel+"</button></div>"+'<div style="width: 50%;"><button class="redactor_modal_action_btn" id="redactor_insert_table_btn">'+this.opts.curLang.insert+"</button></div>"+"</footer>",modal_video:String()+"<section>"+'<form id="redactorInsertVideoForm">'+"<label>"+this.opts.curLang.video_html_code+"</label>"+'<textarea id="redactor_insert_video_area" style="width: 99%; height: 160px;"></textarea>'+"</form>"+"</section>"+"<footer>"+'<div style="width: 50%;"><button class="redactor_btn_modal_close">'+this.opts.curLang.cancel+"</button></div>"+'<div style="width: 50%;"><button class="redactor_modal_action_btn" id="redactor_insert_video_btn">'+this.opts.curLang.insert+"</button></div>"+"</footer>"})},modalInit:function(t,n,r,i){var s=e("#redactor_modal_overlay");if(!s.length){this.$overlay=s=e('<div id="redactor_modal_overlay" style="display: none;"></div>');e("body").prepend(this.$overlay)}if(this.opts.modalOverlay){s.show().on("click",e.proxy(this.modalClose,this))}var o=e("#redactor_modal");if(!o.length){this.$modal=o=e('<div id="redactor_modal" style="display: none;"><div id="redactor_modal_close">&times;</div><header id="redactor_modal_header"></header><div id="redactor_modal_inner"></div></div>');e("body").append(this.$modal)}e("#redactor_modal_close").on("click",e.proxy(this.modalClose,this));this.hdlModalClose=e.proxy(function(e){if(e.keyCode===this.keyCode.ESC){this.modalClose();return false}},this);e(document).keyup(this.hdlModalClose);this.$editor.keyup(this.hdlModalClose);this.modalcontent=false;if(n.indexOf("#")==0){this.modalcontent=e(n);e("#redactor_modal_inner").empty().append(this.modalcontent.html());this.modalcontent.html("")}else{e("#redactor_modal_inner").empty().append(n)}o.find("#redactor_modal_header").html(t);if(typeof e.fn.draggable!=="undefined"){o.draggable({handle:"#redactor_modal_header"});o.find("#redactor_modal_header").css("cursor","move")}var u=e("#redactor_tabs");if(u.length){var a=this;u.find("a").each(function(t,n){t++;e(n).on("click",function(n){n.preventDefault();u.find("a").removeClass("redactor_tabs_act");e(this).addClass("redactor_tabs_act");e(".redactor_tab").hide();e("#redactor_tab"+t).show();e("#redactor_tab_selected").val(t);if(a.isMobile()===false){var r=o.outerHeight();o.css("margin-top","-"+(r+10)/2+"px")}})})}o.find(".redactor_btn_modal_close").on("click",e.proxy(this.modalClose,this));if(this.opts.autoresize===true){this.saveModalScroll=this.document.body.scrollTop}else{this.saveModalScroll=this.$editor.scrollTop()}if(this.isMobile()===false){o.css({position:"fixed",top:"-2000px",left:"50%",width:r+"px",marginLeft:"-"+(r+60)/2+"px"}).show();this.modalSaveBodyOveflow=e(document.body).css("overflow");e(document.body).css("overflow","hidden")}else{o.css({position:"fixed",width:"100%",height:"100%",top:"0",left:"0",margin:"0",minHeight:"300px"}).show()}if(typeof i==="function")i();e(document).off("focusin.modal");if(this.isMobile()===false){setTimeout(function(){var e=o.outerHeight();o.css({top:"50%",height:"auto",minHeight:"auto",marginTop:"-"+(e+10)/2+"px"})},10)}},modalClose:function(){e("#redactor_modal_close").off("click",this.modalClose);e("#redactor_modal").fadeOut("fast",e.proxy(function(){var t=e("#redactor_modal_inner");if(this.modalcontent!==false){this.modalcontent.html(t.html());this.modalcontent=false}t.html("");if(this.opts.modalOverlay){e("#redactor_modal_overlay").hide().off("click",this.modalClose)}e(document).unbind("keyup",this.hdlModalClose);this.$editor.unbind("keyup",this.hdlModalClose);this.selectionRestore();if(this.opts.autoresize&&this.saveModalScroll){e(this.document.body).scrollTop(this.saveModalScroll)}else if(this.opts.autoresize===false&&this.saveModalScroll){this.$editor.scrollTop(this.saveModalScroll)}},this));if(this.isMobile()===false){e(document.body).css("overflow",this.modalSaveBodyOveflow?this.modalSaveBodyOveflow:"visible")}return false},modalSetTab:function(t){e(".redactor_tab").hide();e("#redactor_tabs").find("a").removeClass("redactor_tabs_act").eq(t-1).addClass("redactor_tabs_act");e("#redactor_tab"+t).show()},s3handleFileSelect:function(e){var t=e.target.files;for(var n=0,r;r=t[n];n++){this.s3uploadFile(r)}},s3uploadFile:function(t){this.s3executeOnSignedUrl(t,e.proxy(function(e){this.s3uploadToS3(t,e)},this))},s3executeOnSignedUrl:function(t,n){var r=new XMLHttpRequest;var i="?";if(this.opts.s3.search(/\?/)!="-1")i="&";r.open("GET",this.opts.s3+i+"name="+t.name+"&type="+t.type,true);if(r.overrideMimeType)r.overrideMimeType("text/plain; charset=x-user-defined");r.onreadystatechange=function(t){if(this.readyState==4&&this.status==200){e("#redactor-progress").fadeIn();n(decodeURIComponent(this.responseText))}else if(this.readyState==4&&this.status!=200){}};r.send()},s3createCORSRequest:function(e,t){var n=new XMLHttpRequest;if("withCredentials"in n){n.open(e,t,true)}else if(typeof XDomainRequest!="undefined"){n=new XDomainRequest;n.open(e,t)}else{n=null}return n},s3uploadToS3:function(t,n){var r=this.s3createCORSRequest("PUT",n);if(!r){}else{r.onload=e.proxy(function(){if(r.status==200){e("#redactor-progress, #redactor-progress-drag").hide();var t=n.split("?");if(!t[0]){return false}this.selectionRestore();var i="";i='<img id="image-marker" src="'+t[0]+'" />';if(this.opts.paragraphy)i="<p>"+i+"</p>";this.execCommand("inserthtml",i,false);var s=e(this.$editor.find("img#image-marker"));if(s.length)s.removeAttr("id");else s=false;this.sync();this.callback("imageUpload",s,false);this.modalClose();this.observeImages()}else{}},this);r.onerror=function(){};r.upload.onprogress=function(e){};r.setRequestHeader("Content-Type",t.type);r.setRequestHeader("x-amz-acl","public-read");r.send(t)}},uploadInit:function(t,n){this.uploadOptions={url:false,success:false,error:false,start:false,trigger:false,auto:false,input:false};e.extend(this.uploadOptions,n);var r=e("#"+t);if(r.length&&r[0].tagName==="INPUT"){this.uploadOptions.input=r;this.el=e(r[0].form)}else this.el=r;this.element_action=this.el.attr("action");if(this.uploadOptions.auto){e(this.uploadOptions.input).change(e.proxy(function(e){this.el.submit(function(e){return false});this.uploadSubmit(e)},this))}else if(this.uploadOptions.trigger){e("#"+this.uploadOptions.trigger).click(e.proxy(this.uploadSubmit,this))}},uploadSubmit:function(t){e("#redactor-progress").fadeIn();this.uploadForm(this.element,this.uploadFrame())},uploadFrame:function(){this.id="f"+Math.floor(Math.random()*99999);var t=this.document.createElement("div");var n='<iframe style="display:none" id="'+this.id+'" name="'+this.id+'"></iframe>';t.innerHTML=n;e(t).appendTo("body");if(this.uploadOptions.start)this.uploadOptions.start();e("#"+this.id).load(e.proxy(this.uploadLoaded,this));return this.id},uploadForm:function(t,n){if(this.uploadOptions.input){var r="redactorUploadForm"+this.id,i="redactorUploadFile"+this.id;this.form=e('<form  action="'+this.uploadOptions.url+'" method="POST" target="'+n+'" name="'+r+'" id="'+r+'" enctype="multipart/form-data" />');if(this.opts.uploadFields!==false&&typeof this.opts.uploadFields==="object"){e.each(this.opts.uploadFields,e.proxy(function(t,n){if(n!=null&&n.toString().indexOf("#")===0)n=e(n).val();var r=e("<input/>",{type:"hidden",name:t,value:n});e(this.form).append(r)},this))}var s=this.uploadOptions.input;var o=e(s).clone();e(s).attr("id",i).before(o).appendTo(this.form);e(this.form).css("position","absolute").css("top","-2000px").css("left","-2000px").appendTo("body");this.form.submit()}else{t.attr("target",n).attr("method","POST").attr("enctype","multipart/form-data").attr("action",this.uploadOptions.url);this.element.submit()}},uploadLoaded:function(){var t=e("#"+this.id)[0],n;if(t.contentDocument)n=t.contentDocument;else if(t.contentWindow)n=t.contentWindow.document;else n=window.frames[this.id].document;if(this.uploadOptions.success){e("#redactor-progress").hide();if(typeof n!=="undefined"){var r=n.body.innerHTML;var i=r.match(/\{(.|\n)*\}/)[0];i=i.replace(/^\[/,"");i=i.replace(/\]$/,"");var s=e.parseJSON(i);if(typeof s.error=="undefined")this.uploadOptions.success(s);else{this.uploadOptions.error(this,s);this.modalClose()}}else{this.modalClose();alert("Upload failed!")}}this.el.attr("action",this.element_action);this.el.attr("target","")},draguploadInit:function(t,n){this.draguploadOptions=e.extend({url:false,success:false,error:false,preview:false,uploadFields:false,text:this.opts.curLang.drop_file_here,atext:this.opts.curLang.or_choose,uploadParam:false},n);if(window.FormData===undefined)return false;this.droparea=e('<div class="redactor_droparea"></div>');this.dropareabox=e('<div class="redactor_dropareabox">'+this.draguploadOptions.text+"</div>");this.dropalternative=e('<div class="redactor_dropalternative">'+this.draguploadOptions.atext+"</div>");this.droparea.append(this.dropareabox);e(t).before(this.droparea);e(t).before(this.dropalternative);this.dropareabox.on("dragover",e.proxy(function(){return this.draguploadOndrag()},this));this.dropareabox.on("dragleave",e.proxy(function(){return this.draguploadOndragleave()},this));this.dropareabox.get(0).ondrop=e.proxy(function(e){e.preventDefault();this.dropareabox.removeClass("hover").addClass("drop");this.dragUploadAjax(this.draguploadOptions.url,e.dataTransfer.files[0],false,false,false,this.draguploadOptions.uploadParam)},this)},dragUploadAjax:function(t,n,r,i,s,o){if(!r){var u=e.ajaxSettings.xhr();if(u.upload){u.upload.addEventListener("progress",e.proxy(this.uploadProgress,this),false)}e.ajaxSetup({xhr:function(){return u}})}var a=new FormData;if(o!==false){a.append(o,n)}else{a.append("file",n)}if(this.opts.uploadFields!==false&&typeof this.opts.uploadFields==="object"){e.each(this.opts.uploadFields,e.proxy(function(t,n){if(n!=null&&n.toString().indexOf("#")===0)n=e(n).val();a.append(t,n)},this))}e.ajax({url:t,dataType:"html",data:a,cache:false,contentType:false,processData:false,type:"POST",success:e.proxy(function(t){t=t.replace(/^\[/,"");t=t.replace(/\]$/,"");var n=typeof t==="string"?e.parseJSON(t):t;if(r){i.fadeOut("slow",function(){e(this).remove()});var o=e("<img>");o.attr("src",n.filelink).attr("id","drag-image-marker");this.insertNodeToCaretPositionFromPoint(s,o[0]);var u=e(this.$editor.find("img#drag-image-marker"));if(u.length)u.removeAttr("id");else u=false;this.sync();this.observeImages();if(u)this.callback("imageUpload",u,n);if(typeof n.error!=="undefined")this.callback("imageUploadError",n)}else{if(typeof n.error=="undefined"){this.draguploadOptions.success(n)}else{this.draguploadOptions.error(this,n);this.draguploadOptions.success(false)}}},this)})},draguploadOndrag:function(){this.dropareabox.addClass("hover");return false},draguploadOndragleave:function(){this.dropareabox.removeClass("hover");return false},uploadProgress:function(e,t){var n=e.loaded?parseInt(e.loaded/e.total*100,10):e;this.dropareabox.text("Loading "+n+"% "+(t||""))},isMobile:function(){return/(iPhone|iPod|BlackBerry|Android)/.test(navigator.userAgent)},isIPad:function(){return/iPad/.test(navigator.userAgent)},normalize:function(e){if(typeof e==="undefined")return 0;return parseInt(e.replace("px",""),10)},outerHtml:function(t){return e("<div>").append(e(t).eq(0).clone()).html()},isString:function(e){return Object.prototype.toString.call(e)=="[object String]"},isEmpty:function(e){e=e.replace(/&#x200b;|<br>|<br\/>|&nbsp;/gi,"");e=e.replace(/\s/g,"");e=e.replace(/^<p>[^\W\w\D\d]*?<\/p>$/i,"");return e==""},isIe11:function(){return!!navigator.userAgent.match(/Trident\/7\./)},browser:function(e){var t=navigator.userAgent.toLowerCase();var n=/(opr)[\/]([\w.]+)/.exec(t)||/(chrome)[ \/]([\w.]+)/.exec(t)||/(webkit)[ \/]([\w.]+).*(safari)[ \/]([\w.]+)/.exec(t)||/(webkit)[ \/]([\w.]+)/.exec(t)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(t)||/(msie) ([\w.]+)/.exec(t)||t.indexOf("trident")>=0&&/(rv)(?::| )([\w.]+)/.exec(t)||t.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(t)||[];if(e=="version")return n[2];if(e=="webkit")return n[1]=="chrome"||n[1]=="webkit";if(n[1]=="rv")return e=="msie";if(n[1]=="opr")return e=="webkit";return e==n[1]},oldIE:function(){if(this.browser("msie")&&parseInt(this.browser("version"),10)<9)return true;return false},getFragmentHtml:function(e){var t=e.cloneNode(true);var n=this.document.createElement("div");n.appendChild(t);return n.innerHTML},extractContent:function(){var e=this.$editor[0];var t=this.document.createDocumentFragment();var n;while(n=e.firstChild){t.appendChild(n)}return t},isParentRedactor:function(t){if(!t)return false;if(this.opts.iframe)return t;if(e(t).parents("div.redactor_editor").length==0||e(t).hasClass("redactor_editor"))return false;else return t},currentOrParentIs:function(e){var t=this.getParent(),n=this.getCurrent();return t&&t.tagName===e?t:n&&n.tagName===e?n:false},isEndOfElement:function(){var t=this.getBlock();var n=this.getCaretOffset(t);var r=e.trim(e(t).text()).replace(/\n\r\n/g,"");var i=r.length;if(n==i)return true;else return false},isFocused:function(){var t,n=this.getSelection();if(n&&n.rangeCount&&n.rangeCount>0)t=n.getRangeAt(0).startContainer;if(!t)return false;if(this.opts.iframe){if(this.getCaretOffsetRange().equals())return!this.$editor.is(t);else return true}return e(t).closest("div.redactor_editor").length!=0},removeEmptyAttr:function(t,n){if(e(t).attr(n)=="")e(t).removeAttr(n)},removeFromArrayByValue:function(e,t){var n=null;while((n=e.indexOf(t))!==-1){e.splice(n,1)}return e}};r.prototype.init.prototype=r.prototype;e.Redactor.fn.formatLinkify=function(t,n,r,i,s){var o=/(^|&lt;|\s)(www\..+?\..+?)(\s|&gt;|$)/g,u=/(^|&lt;|\s)(((https?|ftp):\/\/|mailto:).+?)(\s|&gt;|$)/g,a=/(https?:\/\/.*\.(?:png|jpg|jpeg|gif))/gi,f=/https?:\/\/(?:[0-9A-Z-]+\.)?(?:youtu\.be\/|youtube\.com\S*[^\w\-\s])([\w\-]{11})(?=[^\w\-]|$)(?![?=&+%\w.-]*(?:['"][^<>]*>|<\/a>))[?=&+%\w.-]*/ig,l=/https?:\/\/(www\.)?vimeo.com\/(\d+)($|\/)/;var c=(this.$editor?this.$editor.get(0):this).childNodes,h=c.length;while(h--){var p=c[h];if(p.nodeType===3){var d=p.nodeValue;if(i&&d){var v='<iframe width="500" height="281" src="',m='" frameborder="0" allowfullscreen></iframe>';if(d.match(f)){d=d.replace(f,v+"//www.youtube.com/embed/$1"+m);e(p).after(d).remove()}else if(d.match(l)){d=d.replace(l,v+"//player.vimeo.com/video/$2"+m);e(p).after(d).remove()}}if(r&&d&&d.match(a)){d=d.replace(a,'<img src="$1">');e(p).after(d).remove()}if(n&&d&&(d.match(o)||d.match(u))){var g=d.match(o)||d.match(u);g=g[0];if(g.length>s)g=g.substring(0,s)+"...";d=d.replace(/&/g,"&").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(o,'$1<a href="'+t+'$2">'+e.trim(g)+"</a>$3").replace(u,'$1<a href="$2">'+e.trim(g)+"</a>$5");e(p).after(d).remove()}}else if(p.nodeType===1&&!/^(a|button|textarea)$/i.test(p.tagName)){e.Redactor.fn.formatLinkify.call(p,t,n,r,i,s)}}}})(jQuery)